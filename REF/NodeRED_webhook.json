[{
		"id": "92b8f04b.bb5d78",
		"type": "tab",
		"label": "LINE_WEBHOOK",
		"disabled": false,
		"info": ""
	}, {
		"id": "92820d3d.487bc8",
		"type": "tab",
		"label": "LINE_API",
		"disabled": false,
		"info": ""
	}, {
		"id": "952c8d23.7f0d4",
		"type": "tab",
		"label": "Surveillance",
		"disabled": false,
		"info": ""
	}, {
		"id": "61dca38d.78e234",
		"type": "cloudant",
		"z": "",
		"host": "c59d365e-26dc-4430-9f94-2ca4e20e5752-bluemix.cloudant.com",
		"name": "SERVICE-PROD2 的DB"
	}, {
		"id": "fb3184dc.08da7",
		"type": "http in",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"url": "/lineAPI",
		"method": "post",
		"upload": false,
		"swaggerDoc": "",
		"x": 190,
		"y": 80,
		"wires": [["dd01ae44.3d755", "acfdb9e1.31704", "d9be9bc3.093978"]]
	}, {
		"id": "dd01ae44.3d755",
		"type": "http response",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"statusCode": "200",
		"headers": {},
		"x": 430,
		"y": 100,
		"wires": []
	}, {
		"id": "35a9788d.20bdc8",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "來源類型",
		"func": "\nif(\n    msg.payload==null ||\n    msg.payload.events ==null ||\n    msg.payload.events[0]==null ||\n    msg.payload.events[0].source==null ||\n    msg.payload.events[0].source.type==null\n){\n    node.warn(\"非預期訊息來源?\");\n    return null;\n}\n\n\nif(msg.payload.events[0].source.type==\"user\"){\n    msg.target = msg.payload.events[0].source.userId;\n    msg.targetUser = msg.payload.events[0].source.userId;\n}else if(msg.payload.events[0].source.type==\"room\"){    \n    msg.target = msg.payload.events[0].source.roomId;\n    msg.targetUser = msg.payload.events[0].source.userId;\n}else if(msg.payload.events[0].source.type==\"group\"){\n    msg.target = msg.payload.events[0].source.groupId;\n    msg.targetUser = msg.payload.events[0].source.userId;\n}else{\n    node.warn(\"非預期訊息來源?\");\n    return null;\n}\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 590,
		"y": 180,
		"wires": [["b5e90d5c.de9f68", "b118e305.51cf9"]]
	}, {
		"id": "b5e90d5c.de9f68",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "事件類型",
		"func": "if(msg.payload.events[0].type==\"message\"){\n    \n    return [msg,null];\n    \n}else if(msg.payload.events[0].type==\"AAA\"){\n    node.warn(\"不處理事件類型?\");\n}else{\n    node.warn(\"不處理事件類型?\");\n    //包含[follow unfollow join leave postback beacon accountLink]\n}\n\n\n\n",
		"outputs": 2,
		"noerr": 0,
		"x": 770,
		"y": 180,
		"wires": [["ab38a333.31aa38"], []]
	}, {
		"id": "acfdb9e1.31704",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "LINE_IN",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 430,
		"y": 60,
		"wires": []
	}, {
		"id": "6249a1dc.0f56e",
		"type": "http request",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"method": "GET",
		"ret": "obj",
		"url": "",
		"tls": "",
		"x": 900,
		"y": 140,
		"wires": [["a755a19b.d1c21"]]
	}, {
		"id": "33c2ad9.62ed252",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "誰!!!!",
		"active": false,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1180,
		"y": 140,
		"wires": []
	}, {
		"id": "b118e305.51cf9",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"func": "\nlet token = msg.global_para.line_token;\n\nmsg.url = \"https://api.line.me/v2/bot/profile/\"+msg.targetUser;\nmsg.headers = {\n    \"Authorization\": \"Bearer \"+token,\n};\nif(msg.payload.events[0].message){\n    msg.temp = msg.payload.events[0].message.type==\"audio\"?\"傳了聲音 \"+msg.payload.events[0].message.id:msg.temp;\n    msg.temp = msg.payload.events[0].message.type==\"image\"?\"傳了圖片 \"+msg.payload.events[0].message.id:msg.temp;\n    msg.temp = msg.payload.events[0].message.type==\"sticker\"?\"傳送了貼圖[\"+msg.payload.events[0].message.packageId+\",\"+msg.payload.events[0].message.stickerId+\"]\":msg.temp;\n    msg.temp = msg.payload.events[0].message.type==\"text\"?\"說了 \"+msg.payload.events[0].message.text:msg.temp;\n}else{\n    msg.temp = \"EVENT: \" + msg.payload.events[0].type;\n    \n}\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 760,
		"y": 140,
		"wires": [["6249a1dc.0f56e"]]
	}, {
		"id": "d9be9bc3.093978",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "GLOBAL",
		"func": "\nmsg.global_para = {\n    line_token : \"Rr9TVtHn/xIiY7clM+hznaBRHv6r2Wbayq9enRSDwoWKmdGFo25NitxrjT1qgmTOPqCHZ/pLACxIYK/jhpogOP7p7apdL3+083YVer228EZlk1+eP3ILRFrzFUB9hacijo/1glbXcUMvdPgc+b+xoAdB04t89/1O/w1cDnyilFU=\",\n    my_host : \"https://nodered-api-lexus-test.mybluemix.net\"\n};\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 430,
		"y": 143,
		"wires": [["35a9788d.20bdc8"]]
	}, {
		"id": "a755a19b.d1c21",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "發生：",
		"func": "if(msg.payload.displayName){\n    msg.temp = msg.payload.displayName+\" : \"+msg.temp;\n}else{\n    msg.temp = msg.targetUser+\" : \"+msg.temp\n}\n\n//node.warn(msg.temp);\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 1060,
		"y": 140,
		"wires": [["33c2ad9.62ed252"]]
	}, {
		"id": "ab38a333.31aa38",
		"type": "switch",
		"z": "92b8f04b.bb5d78",
		"name": "訊息類型",
		"property": "payload.events[0].message.type",
		"propertyType": "msg",
		"rules": [{
				"t": "eq",
				"v": "text",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "audio",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "image",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "sticker",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "viedo",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "file",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "location",
				"vt": "str"
			}, {
				"t": "else"
			}
		],
		"checkall": "true",
		"repair": false,
		"outputs": 8,
		"x": 440,
		"y": 400,
		"wires": [["6f792c36.08f9dc"], ["afb92b10.278a18"], ["2bf18330.e89a04"], ["c708adac.b080d8"], ["c708adac.b080d8"], ["c708adac.b080d8"], ["c708adac.b080d8"], ["c708adac.b080d8"]]
	}, {
		"id": "cefc392b.760fb",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "轉發 API",
		"active": false,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1030,
		"y": 260,
		"wires": []
	}, {
		"id": "acd685f7.771678",
		"type": "http request",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"method": "POST",
		"ret": "obj",
		"url": "",
		"tls": "",
		"x": 860,
		"y": 300,
		"wires": [["7a029671.04e578", "cefc392b.760fb"]]
	}, {
		"id": "6f792c36.08f9dc",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "文",
		"func": "let user_context = context.flow.get(\"context-\"+msg.target);\nlet my_host = msg.global_para.my_host;\nmsg.url = my_host+\"/servicebot_conversation_1\"\nmsg.payload = {\n    type:\"text\",\n    message:msg.payload.events[0].message.text,\n    replyId:msg.target,\n    context:user_context,\n    //context:\"\",\n    token:\"b68d9f5a-9154-420e-9940-d67f721a16ec\"\n};\nmsg.headers = {'content-type':'application/json'};\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 640,
		"y": 300,
		"wires": [["acd685f7.771678"]]
	}, {
		"id": "c708adac.b080d8",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"func": "let target = msg.target;\nlet messageTemplate=\n{\n    \"to\": target,\n    \"messages\":[\n        {\n            \"type\":\"text\",\n            \"text\":\"謝謝你的訊息，不過我目前無法回復這類訊息喔~\"\n        }\n    ]\n};\n\nmsg.retMsg = messageTemplate;\nreturn msg;\n",
		"outputs": 1,
		"noerr": 0,
		"x": 640,
		"y": 420,
		"wires": [["abcc5cc3.684638"]]
	}, {
		"id": "abcc5cc3.684638",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "TOKEN",
		"func": "\nlet token = msg.global_para.line_token;\nmsg.payload = msg.retMsg;\n\nmsg.url = \"https://api.line.me/v2/bot/message/push\";\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": \"Bearer \"+token,\n};\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 1210,
		"y": 340,
		"wires": [["c00783c.aee468", "c0afed0f.9abc28"]]
	}, {
		"id": "c00783c.aee468",
		"type": "http request",
		"z": "92b8f04b.bb5d78",
		"name": "SEND",
		"method": "POST",
		"ret": "txt",
		"url": "",
		"tls": "",
		"x": 1350,
		"y": 340,
		"wires": [["7fb8a799.9cef08"]]
	}, {
		"id": "d3119ad2.668d18",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "PUSH_TO_LINE",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1530,
		"y": 400,
		"wires": []
	}, {
		"id": "e6b0a892.d0ec48",
		"type": "link in",
		"z": "92b8f04b.bb5d78",
		"name": "PIC_PERSHING_RETURN - B",
		"links": [],
		"x": 1015,
		"y": 400,
		"wires": [["abcc5cc3.684638"]]
	}, {
		"id": "7a029671.04e578",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "CTX",
		"func": "let target = msg.target;\nmsg.payload.to = target;\n//node.warn(msg);\n/*let messageTemplate=\n{\n    \"to\": target,\n    \"messages\": msg.payload\n};\nmsg.retMsg = messageTemplate;\n*/\nmsg.retMsg = msg.payload;\ncontext.flow.set(\"context-\"+target,msg.payload.context);\nreturn msg;\n",
		"outputs": 1,
		"noerr": 0,
		"x": 1060,
		"y": 300,
		"wires": [["abcc5cc3.684638"]]
	}, {
		"id": "d6f98e5a.042ee8",
		"type": "http request",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"method": "GET",
		"ret": "bin",
		"url": "",
		"tls": "",
		"x": 500,
		"y": 500,
		"wires": [["36693e7d.600a52"]]
	}, {
		"id": "d58a6735.502938",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"func": "\nlet content_id = msg.payload.events[0].message.id;\nlet token = msg.global_para.line_token;\n\nmsg.url = \"https://api.line.me/v2/bot/message/\"+content_id+\"/content\";\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": \"Bearer \"+token,\n};\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 350,
		"y": 500,
		"wires": [["d6f98e5a.042ee8"]]
	}, {
		"id": "6d1b9533.2ce93c",
		"type": "http in",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"url": "/fetch_data",
		"method": "get",
		"upload": false,
		"swaggerDoc": "",
		"x": 490,
		"y": 580,
		"wires": [["36693e7d.600a52"]]
	}, {
		"id": "36693e7d.600a52",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "######",
		"func": "if(\n    msg.req && \n    msg.req.route && \n    msg.req.route.path==\"/fetch_data\" &&\n    msg.payload.id\n){\n    let serial_id = new Buffer(msg.payload.id, 'base64').toString('utf-8')\n    \n    msg.headers = context.get(serial_id+\"_headers\");\n    if(msg.headers!=null){\n        msg.headers[\"content-disposition\"]=\"attachment; filename=audioclip-1532332559000-3971.mp4\";\n        msg.headers[\"content-type\"]=\"video/mp4\";\n    }\n    msg.payload = context.get(serial_id+\"_payload\");\n    context.set(serial_id+\"_headers\",null);\n    context.set(serial_id+\"_payload\",null);\n    return[null,msg];\n    //new Buffer(answer).toString('base64')\n}else{\n    let serial_id = UUID();\n    \n    context.set(serial_id+\"_headers\",msg.headers);\n    context.set(serial_id+\"_payload\",msg.payload);\n    \n    msg.dataIdBase64 = new Buffer(serial_id).toString('base64');\n    return[msg,null];\n}\n//return msg;\n\nfunction UUID() {\n  var d = Date.now();\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function'){\n    d += performance.now(); //use high-precision timer if available\n  }\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    var r = (d + Math.random() * 16) % 16 | 0;\n    d = Math.floor(d / 16);\n      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);\n  });\n}\n\n",
		"outputs": 2,
		"noerr": 0,
		"x": 680,
		"y": 540,
		"wires": [["e30a7a97.84adb8"], ["a4e590bf.38f78"]]
	}, {
		"id": "a4e590bf.38f78",
		"type": "http response",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"statusCode": "200",
		"headers": {},
		"x": 850,
		"y": 580,
		"wires": []
	}, {
		"id": "afb92b10.278a18",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "音",
		"func": "msg.type = \"audio\";\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 640,
		"y": 340,
		"wires": [["7220ecd7.3f422c"]]
	}, {
		"id": "2bf18330.e89a04",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "圖",
		"func": "msg.type=\"image\";\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 640,
		"y": 380,
		"wires": [["7220ecd7.3f422c"]]
	}, {
		"id": "e30a7a97.84adb8",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "RETURN",
		"func": "let user_context = context.flow.get(\"context-\"+msg.target);\nlet my_host = msg.global_para.my_host;\nmsg.url = my_host+\"/servicebot_conversation\"\nmsg.payload = {\n    type:msg.type,\n    //message: my_host+\"/fetch_data?id=\"+msg.dataIdBase64,\n    message: \"https://nodered-api-test.mybluemix.net/fetch_data?id=\"+msg.dataIdBase64,\n    context:user_context,\n    token:\"b68d9f5a-9154-420e-9940-d67f721a16ec\"\n};\n//node.warn(my_host+\"/fetch_data?id=\"+msg.dataIdBase64);\nmsg.headers = {'content-type':'application/json'};\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 830,
		"y": 520,
		"wires": [["b5414841.e9cb1"]]
	}, {
		"id": "df492b6f.5cb72",
		"type": "comment",
		"z": "92b8f04b.bb5d78",
		"name": "取回line資料",
		"info": "",
		"x": 210,
		"y": 420,
		"wires": []
	}, {
		"id": "6ebd28a3.8580e",
		"type": "link in",
		"z": "92b8f04b.bb5d78",
		"name": "Line FetchData Retrun-N",
		"links": ["b5414841.e9cb1"],
		"x": 745,
		"y": 320,
		"wires": [["acd685f7.771678"]]
	}, {
		"id": "b5414841.e9cb1",
		"type": "link out",
		"z": "92b8f04b.bb5d78",
		"name": "Line FetchData Retrun-A",
		"links": ["6ebd28a3.8580e"],
		"x": 975,
		"y": 500,
		"wires": []
	}, {
		"id": "7220ecd7.3f422c",
		"type": "link out",
		"z": "92b8f04b.bb5d78",
		"name": "Line FetchData-A",
		"links": ["a023e842.077ca8"],
		"x": 745,
		"y": 360,
		"wires": []
	}, {
		"id": "a023e842.077ca8",
		"type": "link in",
		"z": "92b8f04b.bb5d78",
		"name": "Line FetchData-B",
		"links": ["7220ecd7.3f422c"],
		"x": 235,
		"y": 480,
		"wires": [["d58a6735.502938"]]
	}, {
		"id": "7fb8a799.9cef08",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "PUSH_TO_LINE",
		"func": "if(msg.statusCode==200){\n    node.warn(\"發送成功\");\n}else{\n    node.warn(\"發送失敗 for: \"+msg.payload);\n    //node.warn(msg);\n}\nreturn msg;",
		"outputs": 0,
		"noerr": 0,
		"x": 1530,
		"y": 340,
		"wires": []
	}, {
		"id": "c0afed0f.9abc28",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "BEFORE PUSH",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1370,
		"y": 280,
		"wires": []
	}, {
		"id": "f43259ea.bcb0b",
		"type": "inject",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"topic": "",
		"payload": "",
		"payloadType": "date",
		"repeat": "",
		"crontab": "",
		"once": false,
		"onceDelay": 0.1,
		"x": 330,
		"y": 800,
		"wires": [["30b16a66.3fbae6"]]
	}, {
		"id": "a9541863.73e7d",
		"type": "http request",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"method": "POST",
		"ret": "txt",
		"url": "",
		"tls": "",
		"x": 866,
		"y": 800,
		"wires": [["d48be9d3.06cc2"]]
	}, {
		"id": "adf25d16.3d4bb",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "CREATE",
		"func": "msg.url = \"https://api.line.me/v2/bot/richmenu\";\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": \"Bearer \"+msg.flow_para.line_token,\n};\nmsg.payload = {\n    //https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/rich_menu/richmenu.jpg\n    \"size\": {\n      \"width\": 2500,\n      \"height\": 1686\n    }, // 833 843\n    \"selected\": false,\n    \"name\": \"tyt_rich_menu\",\n    \"chatBarText\": \"查看更多資訊\",\n    \"areas\": [\n      {\n        \"bounds\": {\n          \"x\": 0,\n          \"y\": 0,\n          \"width\":833,\n          \"height\": 843\n        },\n        \"action\": {  \n           \"type\":\"message\",\n           \"label\":\"品牌活動\",\n           \"text\":\"品牌活動\"\n        }\n      },{\n        \"bounds\": {\n          \"x\": 833,\n          \"y\": 0,\n          \"width\":833,\n          \"height\": 843\n        },\n        \"action\": {  \n           \"type\":\"message\",\n           \"label\":\"鄰近據點\",\n           \"text\":\"鄰近據點\"\n        }\n      },{\n        \"bounds\": {\n          \"x\": 1666,\n          \"y\": 0,\n          \"width\":833,\n          \"height\": 843\n        },\n        \"action\": {  \n           \"type\":\"message\",\n           \"label\":\"行動展間\",\n           \"text\":\"行動展間\"\n        }\n      },{\n        \"bounds\": {\n          \"x\": 0,\n          \"y\": 843,\n          \"width\":833,\n          \"height\": 843\n        },\n        \"action\": {  \n           \"type\":\"message\",\n           \"label\":\"行動客服\",\n           \"text\":\"行動客服\"\n        }\n      },{\n        \"bounds\": {\n          \"x\": 833,\n          \"y\": 843,\n          \"width\":833,\n          \"height\": 843\n        },\n        \"action\": {  \n           \"type\":\"message\",\n           \"label\":\"行車管家\",\n           \"text\":\"行車管家\"\n        }\n      },{\n        \"bounds\": {\n          \"x\": 1666,\n          \"y\": 843,\n          \"width\":833,\n          \"height\": 843\n        },\n        \"action\": {  \n           \"type\":\"message\",\n           \"label\":\"車主服務\",\n           \"text\":\"車主服務\"\n        }\n      }\n   ]\n}\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 670,
		"y": 800,
		"wires": [["a9541863.73e7d"]]
	}, {
		"id": "30b16a66.3fbae6",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"func": "msg.flow_para = {\n    line_token : \"Rr9TVtHn/xIiY7clM+hznaBRHv6r2Wbayq9enRSDwoWKmdGFo25NitxrjT1qgmTOPqCHZ/pLACxIYK/jhpogOP7p7apdL3+083YVer228EZlk1+eP3ILRFrzFUB9hacijo/1glbXcUMvdPgc+b+xoAdB04t89/1O/w1cDnyilFU=\",\n    my_host : \"https://nodered-api-lexus-test.mybluemix.net\"\n};\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 500,
		"y": 800,
		"wires": [["adf25d16.3d4bb"]]
	}, {
		"id": "d48be9d3.06cc2",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1053,
		"y": 800,
		"wires": []
	}, {
		"id": "66ea6026.595b68",
		"type": "comment",
		"z": "92b8f04b.bb5d78",
		"name": "SET IMAGE",
		"info": "curl -v -X POST https://api.line.me/v2/bot/richmenu/richmenu-15524099dee76b3a67efb838b43a11ba/content -H \"Authorization: Bearer Rr9TVtHn/xIiY7clM+hznaBRHv6r2Wbayq9enRSDwoWKmdGFo25NitxrjT1qgmTOPqCHZ/pLACxIYK/jhpogOP7p7apdL3+083YVer228EZlk1+eP3ILRFrzFUB9hacijo/1glbXcUMvdPgc+b+xoAdB04t89/1O/w1cDnyilFU=\" -H \"Content-Type: image/jpeg\" -T richmenu.jpg",
		"x": 680,
		"y": 840,
		"wires": []
	}, {
		"id": "65f7aecf.ef2f4",
		"type": "comment",
		"z": "92b8f04b.bb5d78",
		"name": "SET DEFAULT",
		"info": "curl -v -X POST https://api.line.me/v2/bot/user/all/richmenu/richmenu-4ba4ee4ba10c122e434d62b044b64217 -d '' -H \"Authorization: Bearer Rr9TVtHn/xIiY7clM+hznaBRHv6r2Wbayq9enRSDwoWKmdGFo25NitxrjT1qgmTOPqCHZ/pLACxIYK/jhpogOP7p7apdL3+083YVer228EZlk1+eP3ILRFrzFUB9hacijo/1glbXcUMvdPgc+b+xoAdB04t89/1O/w1cDnyilFU=\"",
		"x": 930,
		"y": 840,
		"wires": []
	}, {
		"id": "fa07c6b1.5f4d",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1060,
		"y": 940,
		"wires": []
	}, {
		"id": "3d1f6329.f8057c",
		"type": "http request",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"method": "POST",
		"ret": "txt",
		"url": "",
		"tls": "",
		"x": 873,
		"y": 940,
		"wires": [["fa07c6b1.5f4d"]]
	}, {
		"id": "594127ab.850278",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "SET DEFAULT",
		"func": "msg.url = \"https://api.line.me/v2/bot/user/all/richmenu/richmenu-15524099dee76b3a67efb838b43a11ba\";\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": \"Bearer \"+msg.flow_para.line_token,\n};\nmsg.payload={};\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 697,
		"y": 940,
		"wires": [["3d1f6329.f8057c"]]
	}, {
		"id": "b93b42dc.98c2d",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"func": "msg.flow_para = {\n    line_token : \"Rr9TVtHn/xIiY7clM+hznaBRHv6r2Wbayq9enRSDwoWKmdGFo25NitxrjT1qgmTOPqCHZ/pLACxIYK/jhpogOP7p7apdL3+083YVer228EZlk1+eP3ILRFrzFUB9hacijo/1glbXcUMvdPgc+b+xoAdB04t89/1O/w1cDnyilFU=\",\n    my_host : \"https://nodered-api-lexus-test.mybluemix.net\"\n};\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 507,
		"y": 940,
		"wires": [["594127ab.850278"]]
	}, {
		"id": "f86dad28.3ca35",
		"type": "inject",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"topic": "",
		"payload": "",
		"payloadType": "date",
		"repeat": "",
		"crontab": "",
		"once": false,
		"onceDelay": 0.1,
		"x": 337,
		"y": 940,
		"wires": [[]]
	}, {
		"id": "ae952a8d.07166",
		"type": "http in",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"url": "/ht_api/LINE006_Q00",
		"method": "post",
		"upload": false,
		"swaggerDoc": "",
		"x": 390,
		"y": 1140,
		"wires": [["a2c34ce1.0b0c", "a12faeaf.005308"]]
	}, {
		"id": "a2c34ce1.0b0c",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "cust查詢",
		"func": "\nmsg.payload = JSON.parse(msg.payload.jsonstr);\n\nmsg.payload = {\n    \"rtnCode\": \"0\",\n    \"rtnMsg\": \"\",\n    \"CSINFO\": [\n        {\n            \"LICSNO\": \"NUM-0\"+Math.abs(myHashCode(msg.payload.ENCYID)%100),\n            \"FRAN\": \"L\",\n            \"CARNM\": \"IS300h\",\n            \"CRCOMPID\": \"AA\",\n            \"CRSALR\": \"AA00001\",\n            \"CRSALRNM\": \"陳柏廷\",\n            \"SRCOMPID\": \"AA\",\n            \"WHSRVNO\": \"AA00002\",\n            \"WHSRVNM\": \"劉孟函\",\n            \"NICKNAME\": corresponse_name(msg.payload.ENCYID),\n            \"PICURL\": \"https://htsr.hotaimotor.com.tw/LINEAPI/IMG/user.jpg\"\n        }\n    ]\n}\n\nreturn msg;\n\nfunction corresponse_name(replyID){\n    let name_list = [\"楊宏偉\",\"賴文豪\",\"鄧淑娟\",\"余名誠\",\"陳世順\",\"林宏儒\",\"賴哲豪\",\"黃雅惠\",\"陳嘉雯\",\"楊上和\",\"劉育娥\",\"沈林廷\",\"鄧怡如\",\"趙于婷\",\"張珮甄\",\"吳雅惠\",\"吳紋火\",\"周志然\",\"胥歡雅\",\"陳修木\",\"陳俊憲\",\"張志銘\",\"卞苡佩\",\"李鎮帆\",\"藍素順\",\"袁儒瑄\",\"陳君函\",\"陳家豪\",\"陳俊憲\",\"涂秋添\",\"周怡桂\",\"鄭伊然\",\"陳思妃\",\"黃惠珠\",\"黃明翰\",\"羅雅晴\",\"蔡涵郁\",\"蕭怡婷\",\"林柏青\",\"王姿孜\",\"宣初強\",\"李智翔\",\"陳家英\",\"李鳳儒\",\"李予添\",\"周玄誠\",\"許宇翔\",\"黃雅文\",\"王佩璇\",\"郭幼能\",\"駱雅婷\",\"吳偉婷\",\"林惠婷\",\"吳士銘\",\"李宜珮\",\"杜怡君\",\"鄭鈺婷\",\"張志帆\",\"林進松\",\"涂豪舜\",\"張家和\",\"張惠敏\",\"金美玉\",\"曹俊瑋\",\"吳欣士\",\"黃俊明\",\"華青全\",\"陳依婷\",\"陳怡婷\",\"陳盈如\",\"林建彰\",\"吳明安\",\"吳湘婷\",\"林惠珠\",\"陳大喬\",\"鄭怡嘉\",\"倪胤嬌\",\"宋雅琪\",\"錢辰嘉\",\"陳智易\",\"徐采盛\",\"夏益迪\",\"陳佳怡\",\"白胤紋\",\"李雅婷\",\"林智翔\",\"傅家豪\",\"宓士凱\",\"張瑜桓\",\"喻祥玄\",\"陳宏麟\",\"胡林帆\",\"邱志祥\",\"吳雅謙\",\"張怡竹\",\"林韋梅\",\"朱佩穎\",\"洪淑季\",\"李志筠\",\"謝添士\"];\n    \n    return name_list[Math.abs(myHashCode(replyID)%100)];\n}\nfunction myHashCode(str) {\n  var hash = 0, i, chr;\n  if (str.length === 0) return hash;\n  for (i = 0; i < str.length; i++) {\n    chr   = str.charCodeAt(i);\n    hash  = ((hash << 5) - hash) + chr;\n    hash |= 0; // Convert to 32bit integer\n  }\n  return hash;\n};",
		"outputs": 1,
		"noerr": 0,
		"x": 650,
		"y": 1140,
		"wires": [["aaac929b.3dde1"]]
	}, {
		"id": "aaac929b.3dde1",
		"type": "http response",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"statusCode": "200",
		"headers": {},
		"x": 858,
		"y": 1140,
		"wires": []
	}, {
		"id": "dc57a23a.3fb54",
		"type": "http in",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"url": "/ht_api/LINE006_Q01",
		"method": "post",
		"upload": false,
		"swaggerDoc": "",
		"x": 389,
		"y": 1188,
		"wires": [["818a69c3.cd63f8", "a12faeaf.005308"]]
	}, {
		"id": "818a69c3.cd63f8",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "serv列表",
		"func": "msg.payload = JSON.parse(msg.payload.jsonstr);\n\nmsg.payload = {\n    \"rtnCode\": \"0\",\n    \"rtnMsg\": \"\",\n    \"USERINFO\": [\n        {\n            \"LICSNO\": \"RBD-0021\",\n            \"FRAN\": \"L\",\n            \"CARNM\": \"IS300h\",\n            \"ENCYID\": \"C0001\",\n            \"MOBILE\": \"0919863010\",\n            \"NICKNAME\": \"測試使用者1\",\n            \"PICURL\": \"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQIGa49DabvTpQldi1JH7KHt2TeGFmn_3g4U2jAegFdvRLFunkYQg\",\n            \"FENDAT\": \"19000101\",\n            \"UENDAT\": \"19000101\",\n            \"BRTHDT\": \"19911111\",\n            \"FFLAG\": \"Y\",\n            \"UFLAG\": \"Y\",\n            \"BIRFLAG\": \"Y\",\n            \"USERID\": msg.payload.USERID\n        },\n        {\n            \"LICSNO\": \"RBD-0022\",\n            \"FRAN\": \"L\",\n            \"CARNM\": \"IS300h\",\n            \"ENCYID\": \"C0002\",\n            \"MOBILE\": \"0919863010\",\n            \"NICKNAME\": \"測試使用者2\",\n            \"PICURL\": \"https://im1.book.com.tw/image/getImage?i=https://www.books.com.tw/img/001/079/99/0010799970.jpg&v=5ba225b9&w=348&h=348\",\n            \"FENDAT\": \"19000101\",\n            \"UENDAT\": \"19000101\",\n            \"BRTHDT\": \"19911111\",\n            \"FFLAG\": \"Y\",\n            \"UFLAG\": \"Y\",\n            \"BIRFLAG\": \"Y\",\n            \"USERID\": msg.payload.USERID\n        },\n        {\n            \"LICSNO\": \"RBD-0023\",\n            \"FRAN\": \"L\",\n            \"CARNM\": \"IS300h\",\n            \"ENCYID\": \"C0003\",\n            \"MOBILE\": \"0919863010\",\n            \"NICKNAME\": \"測試使用者3\",\n            \"PICURL\": \"http://blog.accupass.com/wp-content/uploads/2017/03/1_120122230539_1.jpg\",\n            \"FENDAT\": \"19000101\",\n            \"UENDAT\": \"19000101\",\n            \"BRTHDT\": \"19911111\",\n            \"FFLAG\": \"Y\",\n            \"UFLAG\": \"Y\",\n            \"BIRFLAG\": \"Y\",\n            \"USERID\": msg.payload.USERID\n        }\n    ]\n}\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 649,
		"y": 1188,
		"wires": [["8790be9a.07e968"]]
	}, {
		"id": "8790be9a.07e968",
		"type": "http response",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"statusCode": "200",
		"headers": {},
		"x": 857,
		"y": 1188,
		"wires": []
	}, {
		"id": "2688bd86.8c8d3a",
		"type": "http in",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"url": "/ht_api/USER_LOGIN",
		"method": "post",
		"upload": false,
		"swaggerDoc": "",
		"x": 388,
		"y": 1235,
		"wires": [["628b4df2.a1c75c", "a12faeaf.005308"]]
	}, {
		"id": "628b4df2.a1c75c",
		"type": "function",
		"z": "92b8f04b.bb5d78",
		"name": "serv登入",
		"func": "msg.payload = JSON.parse(msg.payload.jsonstr);\n\nlet manager_dict = {\n    \"AA00001\":\"陳柏廷\",\n    \"AA00002\":\"劉孟函\",\n    \"AA94453\":\"預設管理員1\",\n    \"AA99061\":\"預設管理員2\"\n}\n\nmsg.payload = {\n    \"rtnCode\": \"0\",\n    \"rtnMsg\": \"\",\n    \"FLAG\": \"Y\",\n    \"COMPID\": \"AA\",\n    \"DLRCD\": \"A\",\n    \"BRNHCD\": \"01\",\n    \"SECTCD\": \"0\",\n    \"FRAN\": \"L\",\n    \"USERID\": msg.payload.USERID,\n    \"USERNM\": manager_dict[msg.payload.USERID],\n    \"ECHOTITLECD\": \"D\",\n    \"COMPSIMPNM\": \"國都汽車\",\n    \"DEPTSIMPNM\": \"丹鳳服務廠\"\n}\n\nreturn msg;\n",
		"outputs": 1,
		"noerr": 0,
		"x": 648,
		"y": 1235,
		"wires": [["fcc72986.5af038"]]
	}, {
		"id": "fcc72986.5af038",
		"type": "http response",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"statusCode": "200",
		"headers": {},
		"x": 856,
		"y": 1235,
		"wires": []
	}, {
		"id": "a12faeaf.005308",
		"type": "debug",
		"z": "92b8f04b.bb5d78",
		"name": "",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 640,
		"y": 1300,
		"wires": []
	}, {
		"id": "5e49e292.9208ec",
		"type": "http in",
		"z": "92820d3d.487bc8",
		"name": "",
		"url": "/servicebot_conversation",
		"method": "post",
		"upload": false,
		"swaggerDoc": "",
		"x": 328.566650390625,
		"y": 455,
		"wires": [["d976d502.688fd8"]]
	}, {
		"id": "2891cb43.bcbe94",
		"type": "switch",
		"z": "92820d3d.487bc8",
		"name": "TokenCheck",
		"property": "payload.token",
		"propertyType": "msg",
		"rules": [{
				"t": "eq",
				"v": "b68d9f5a-9154-420e-9940-d67f721a16ec",
				"vt": "str"
			}, {
				"t": "else"
			}
		],
		"checkall": "true",
		"repair": false,
		"outputs": 2,
		"x": 728.566650390625,
		"y": 375,
		"wires": [["a7fa95fb.0e5ea8", "12349448.2b14ec"], ["2fd56221.07aba6"]]
	}, {
		"id": "2fd56221.07aba6",
		"type": "template",
		"z": "92820d3d.487bc8",
		"name": "",
		"field": "payload",
		"fieldType": "msg",
		"format": "handlebars",
		"syntax": "mustache",
		"template": "{\n\t\"error\": {\n\t\t\"message\": \"Error validating token.\",\n\t\t\"type\": \"OAuthException\"\n\t}\n}\n",
		"output": "json",
		"x": 898.566650390625,
		"y": 415,
		"wires": [["89b71c2b.ef201", "c151879.ccea678"]]
	}, {
		"id": "a7fa95fb.0e5ea8",
		"type": "switch",
		"z": "92820d3d.487bc8",
		"name": "MsgFormatCheck",
		"property": "payload.type",
		"propertyType": "msg",
		"rules": [{
				"t": "eq",
				"v": "text",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "image",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "audio",
				"vt": "str"
			}, {
				"t": "else"
			}
		],
		"checkall": "true",
		"repair": false,
		"outputs": 4,
		"x": 918.566650390625,
		"y": 335,
		"wires": [["de7bb964.87525"], ["76dcf504.62534c"], ["14dc42c0.f297cd"], ["860a0644.5875f8"]]
	}, {
		"id": "89b71c2b.ef201",
		"type": "http response",
		"z": "92820d3d.487bc8",
		"name": "",
		"statusCode": "401",
		"headers": {},
		"x": 1058.566650390625,
		"y": 435,
		"wires": []
	}, {
		"id": "d434fc4e.92eb4",
		"type": "http response",
		"z": "92820d3d.487bc8",
		"name": "Response",
		"statusCode": "200",
		"headers": {},
		"x": 1508.566650390625,
		"y": 295,
		"wires": []
	}, {
		"id": "823c88da.d8b61",
		"type": "http response",
		"z": "92820d3d.487bc8",
		"name": "",
		"statusCode": "400",
		"headers": {},
		"x": 1298.566650390625,
		"y": 415,
		"wires": []
	}, {
		"id": "860a0644.5875f8",
		"type": "template",
		"z": "92820d3d.487bc8",
		"name": "",
		"field": "payload",
		"fieldType": "msg",
		"format": "handlebars",
		"syntax": "mustache",
		"template": "{\n\t\"error\": {\n\t\t\"message\": \"Unexception message type.\",\n\t\t\"type\": \"BadRequest\"\n\t}\n}\n",
		"output": "json",
		"x": 1118.566650390625,
		"y": 395,
		"wires": [["823c88da.d8b61", "6b6a8751.6a768"]]
	}, {
		"id": "925a6aa6.de0728",
		"type": "debug",
		"z": "92820d3d.487bc8",
		"name": "RequestMessage",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 588.566650390625,
		"y": 335,
		"wires": []
	}, {
		"id": "b18bb317.97598",
		"type": "debug",
		"z": "92820d3d.487bc8",
		"name": "ResponseMessage",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1538.566650390625,
		"y": 255,
		"wires": []
	}, {
		"id": "b5026eb6.eea8e",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "ContextDeal",
		"func": "msg.flow_config.time_record.response_time = Date.now();\n\nmsg.payload = msg.retMsg;\n\nlet context = null;\n//1.最基礎有進來的context\n//2.如果有出來 而且不是hardcode的\ncontext = msg.req_para!=null && msg.req_para.context!=null\n            ? msg.req_para.context : context;\ncontext = msg.assistant_says!=null && msg.assistant_says.context!=null && msg.assistant_says.context.conversation_id!=null\n            ? msg.assistant_says.context : context;\n\nmsg.payload.context = context;\n\nif(msg.payload.context && msg.payload.context.doActions){\n    delete msg.payload.context.doActions;\n}\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 1288.566650390625,
		"y": 315,
		"wires": [["d434fc4e.92eb4", "b18bb317.97598", "760fdb37.0091e4"]]
	}, {
		"id": "de7bb964.87525",
		"type": "link out",
		"z": "92820d3d.487bc8",
		"name": "Line TextMessage IN - A",
		"links": ["ddb875c2.acfab8", "d0ca8756.0703a8"],
		"x": 1093.566650390625,
		"y": 275,
		"wires": []
	}, {
		"id": "8438b525.1e6c88",
		"type": "link out",
		"z": "92820d3d.487bc8",
		"name": "Line TextMessage OUT - B",
		"links": ["fbc5d702.244398"],
		"x": 953.566650390625,
		"y": 1195,
		"wires": []
	}, {
		"id": "fbc5d702.244398",
		"type": "link in",
		"z": "92820d3d.487bc8",
		"name": "Line TextMessage OUT - A",
		"links": ["8438b525.1e6c88", "71706500.b9b98c", "3b07f1f5.31025e"],
		"x": 1153.566650390625,
		"y": 275,
		"wires": [["b5026eb6.eea8e", "ab31ca9d.44487"]]
	}, {
		"id": "edf39080.fcc",
		"type": "link in",
		"z": "92820d3d.487bc8",
		"name": "華生說-B for 5",
		"links": ["ddda1664.1c09c8", "a5061e9.e31a1e", "bd2ff7d.1dff808", "9ec72007.14fdc8"],
		"x": 213.566650390625,
		"y": 1215,
		"wires": [["bdc701f2.a0be48"]]
	}, {
		"id": "73891008.fc269",
		"type": "switch",
		"z": "92820d3d.487bc8",
		"name": "",
		"property": "watson_doAction.type",
		"propertyType": "msg",
		"rules": [{
				"t": "eq",
				"v": "text",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "my_btns",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "carousel",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "image_carousel",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "buttons",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "promote_activity",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "some_menu",
				"vt": "str"
			}, {
				"t": "eq",
				"v": "special_coordinator",
				"vt": "str"
			}, {
				"t": "else"
			}
		],
		"checkall": "true",
		"repair": false,
		"outputs": 9,
		"x": 448.566650390625,
		"y": 1215,
		"wires": [["47ab978f.8e6ea"], ["d9b93388.a3853"], ["907e65f.04d5318"], ["b20a6cc1.59e26"], ["7a79aa85.150cc4"], ["d913ce2c.20f2c8"], ["a02b133c.97e238"], ["8529b27a.9f9a18"], ["63f0e1b9.1fef5"]]
	}, {
		"id": "47ab978f.8e6ea",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "text",
		"func": "\nlet target = msg.target;\nlet messageTemplate=\n{\n    \"to\": target,\n    \"messages\":[\n        msg.watson_doAction\n        \n    ]\n};\nmsg.retMsg = messageTemplate;\nreturn msg;\n",
		"outputs": 1,
		"noerr": 0,
		"x": 728.5667724609375,
		"y": 1088,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "d9b93388.a3853",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "my_btns",
		"func": "let target = msg.target;\nlet watson_doAction= msg.watson_doAction;\n\nlet btns =[];\nfor(let i=0;i<watson_doAction.buttonAssign.length;i++){\n    btns.push({\n\t\t\"type\": \"message\",\n\t\t\"label\": watson_doAction.buttonAssign[i],\n\t\t\"text\": watson_doAction.buttonAssign[i]\n\t});\n}\nwhile(btns.length>4){\n    btns.pop();\n}\n\nlet messageTemplate=\n{\n\t\"to\": target,\n\t\"messages\": [{\n\t\t\"type\": \"template\",\n\t\t\"altText\": watson_doAction.buttonTitle,\n\t\t\"template\": {\n\t\t\t\"type\": \"buttons\",\n\t\t\t\"text\": watson_doAction.buttonTitle,\n\t\t\t\"actions\": btns\n\t\t}\n\t}]\n};\n\nmsg.retMsg = messageTemplate;\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 737.5667724609375,
		"y": 1128,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "5ad89196.90b1b",
		"type": "comment",
		"z": "92820d3d.487bc8",
		"name": "Assistant",
		"info": "",
		"x": 198.566650390625,
		"y": 655,
		"wires": []
	}, {
		"id": "45def539.2ce82c",
		"type": "comment",
		"z": "92820d3d.487bc8",
		"name": "訊息轉Template處理",
		"info": "",
		"x": 248.566650390625,
		"y": 1115,
		"wires": []
	}, {
		"id": "b280d94f.268ad8",
		"type": "comment",
		"z": "92820d3d.487bc8",
		"name": "API In",
		"info": "",
		"x": 208.566650390625,
		"y": 295,
		"wires": []
	}, {
		"id": "907e65f.04d5318",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "carousel",
		"func": "let target = msg.target;\nlet watson_doAction= msg.watson_doAction;\n\n\nfor (let j = 0; watson_doAction.columns && j<watson_doAction.columns.length ; j++) {\n    \n    let column = watson_doAction.columns[j];\n    if(column.imageUrl!=null){\n        column.thumbnailImageUrl = column.imageUrl;\n        delete column.imageUrl;\n    }\n    if(column.actions && column.actions.length==1 && column.actions[0].type==\"uri\" && column.defaultAction==null){\n        column.defaultAction = column.actions[0];\n        delete column.imageUrl;\n    }\n    \n}\n\nlet messageTemplate=\n{\n\t\"to\": target,\n\t\"messages\": (watson_doAction.text\n\t?[{\n        \"type\":\"text\",\n        \"text\":watson_doAction.text\n    }]\n    :[]\n    ).concat(\n        [{\n    \t\t\"type\": \"template\",\n    \t\t\"altText\": watson_doAction.altText,\n    \t\t\"template\": {\n    \t\t\t\"type\": watson_doAction.type,\n    \t\t    \"imageAspectRatio\": watson_doAction.imageAspectRatio?watson_doAction.imageAspectRatio:\"rectangle\",//\"square\",\n                \"imageSize\": \"cover\",//\"contain\",\n    \t\t\t\"columns\": watson_doAction.columns,\n    \t\t}\n    \t}]\n\t)\n};\nmsg.retMsg = messageTemplate;\nreturn msg;\n",
		"outputs": 1,
		"noerr": 0,
		"x": 738.5665283203125,
		"y": 1165.25,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "bdc701f2.a0be48",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "if(Array.isArray(msg.watson_doActions) && msg.watson_doActions.length>0){\n    msg.watson_doAction = msg.watson_doActions[0];\n}\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 308.566650390625,
		"y": 1215,
		"wires": [["73891008.fc269"]]
	}, {
		"id": "63f0e1b9.1fef5",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "anythingElse",
		"func": "\nmsg.retMsg = {};\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 748.566650390625,
		"y": 1475,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "b20a6cc1.59e26",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "image_carousel",
		"func": "let target = msg.target;\nlet watson_doAction= msg.watson_doAction;\n\nlet messageTemplate=\n{\n\t\"to\": target,\n\t\"messages\": [{\n        \"type\":\"text\",\n        \"text\":watson_doAction.text\n    },{\n\t\t\"type\": \"template\",\n\t\t\"altText\": watson_doAction.altText,\n\t\t\"template\": {\n\t\t\t\"type\": watson_doAction.type,\n\t\t\t\"columns\": watson_doAction.columns,\n\t\t\t//\"imageSize\": \"cover\"\n\t\t}\n\t}]\n};\nmsg.retMsg = messageTemplate;\nreturn msg;\n",
		"outputs": 1,
		"noerr": 0,
		"x": 758.566650390625,
		"y": 1208,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "7a79aa85.150cc4",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "buttons",
		"func": "let target = msg.target;\nlet watson_doAction= msg.watson_doAction;\n\nlet messageTemplate=\n{\n\t\"to\": target,\n\t\"messages\": [{\n\t\t\"type\": \"template\",\n\t\t\"altText\": watson_doAction.altText,\n\t\t\"template\": {\n\t\t\t\"type\": \"buttons\",\n\t\t\t\"text\": watson_doAction.text,\n\t\t\t\"actions\": watson_doAction.actions\n\t\t}\n\t}]\n};\n\nmsg.retMsg = messageTemplate;\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 728.566650390625,
		"y": 1250,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "667ebe39.4e2588",
		"type": "catch",
		"z": "92820d3d.487bc8",
		"name": "",
		"scope": ["5e49e292.9208ec", "63f0e1b9.1fef5", "b280d94f.268ad8", "5ad89196.90b1b", "14dc42c0.f297cd", "7a79aa85.150cc4", "907e65f.04d5318", "e8c7dcee.96e6c", "b5026eb6.eea8e", "12349448.2b14ec", "98169f83.c71a8", "27640eb.d6bc6f2", "9277f51.12b3f88", "b672a78c.cb5848", "bdc701f2.a0be48", "c69c6f61.1a7bf", "7f521b9a.fdb77c", "9e8c50e6.80bca8", "2e2e35e.527334a", "99d10caa.e4037", "de9a28be.2efb58", "7456d913.ac2d58", "6b6a8751.6a768", "c151879.ccea678", "e416fa27.9446d", "823c88da.d8b61", "89b71c2b.ef201", "b20a6cc1.59e26", "de7bb964.87525", "d0ca8756.0703a8", "fbc5d702.244398", "8438b525.1e6c88", "2e402ea.eb304d2", "b5175248.95a3c8", "dc0daa6.1f40858", "c2e992c9.184ca", "d913ce2c.20f2c8", "a7fa95fb.0e5ea8", "d9b93388.a3853", "76dcf504.62534c", "c06faf96.20aec", "760fdb37.0091e4", "925a6aa6.de0728", "d434fc4e.92eb4", "b18bb317.97598", "36001c1f.f3e78c", "993141cd.9061a8", "cf906e5d.e3f68", "a02b133c.97e238", "73891008.fc269", "2fd56221.07aba6", "860a0644.5875f8", "47ab978f.8e6ea", "2891cb43.bcbe94", "9e72530f.7ab01", "9ec72007.14fdc8", "edf39080.fcc", "45def539.2ce82c"],
		"x": 288.566650390625,
		"y": 135,
		"wires": [["6cce82ff.1db36c", "34b95e15.0970d2"]]
	}, {
		"id": "34b95e15.0970d2",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "ERROR",
		"func": "\nlet timestamp = Date.now();\n\nmsg.payload = {\n    type:\"system_occurred\",\n    error: msg.error,\n    req_para: msg.req_para,\n    timestamp: timestamp,\n    time: new Date(new Date(timestamp).getTime()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]\n};\n\nnode.status({fill:\"red\",shape:\"dot\",text:new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]+JSON.stringify(msg.error)});\n\nif(msg.res){\n    return [msg,msg,{\n        payload:{\n            error_type:\"system_occurred\",\n            error:msg.error\n        }\n    }];\n}else{\n    return [msg,null,{\n        payload:{\n            error_type:\"system_occurred\",\n            error:msg.error\n        }\n    }];\n}",
		"outputs": 3,
		"noerr": 0,
		"x": 488.566650390625,
		"y": 115,
		"wires": [["5a0fc45.378e23c"], ["d76a01d0.4223b8"], ["d1d35fd4.26c8d8"]]
	}, {
		"id": "f41656fb.2f902",
		"type": "http response",
		"z": "92820d3d.487bc8",
		"name": "ERROR",
		"statusCode": "500",
		"headers": {},
		"x": 848.566650390625,
		"y": 154,
		"wires": []
	}, {
		"id": "d76a01d0.4223b8",
		"type": "template",
		"z": "92820d3d.487bc8",
		"name": "ERROR",
		"field": "payload",
		"fieldType": "msg",
		"format": "handlebars",
		"syntax": "mustache",
		"template": "{\n\t\"error\": {\n\t\t\"message\": \"Unexception error.\",\n\t\t\"type\": \"Internal Server Error\"\n\t}\n}\n",
		"output": "json",
		"x": 668.566650390625,
		"y": 135,
		"wires": [["f41656fb.2f902"]]
	}, {
		"id": "6cce82ff.1db36c",
		"type": "debug",
		"z": "92820d3d.487bc8",
		"name": "ERROR",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 478.566650390625,
		"y": 175,
		"wires": []
	}, {
		"id": "a02b133c.97e238",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "some_menu",
		"func": "let target =  msg.target;\nlet HT_image_space = msg.flow_config.HT_image_space;\nlet imageMap = {\n  \"type\": \"imagemap\",\n  \"baseUrl\": HT_image_space+\"service_menu\",\n  \"altText\": \"TOYOTA_LINE_個人化服務\",\n  \"baseSize\": {\n      \"height\": 1040,\n      \"width\": 1040\n  },\n  \"actions\": [\n      {\n          //認證中古車\n          \"type\": \"uri\",\n          \"linkUri\": \"https://www.toyota.com.tw/sh/\",\n          \"area\": {\n              \"x\": 1,\n              \"y\": 180,\n              \"width\": 518,\n              \"height\": 199\n          }\n      },\n      {\n          //驅動城市\n          \"type\": \"uri\",\n          \"linkUri\": \"https://www.toyota.com.tw/app/citydriver/\",\n          \"area\": {\n              \"x\": 522,\n              \"y\": 181,\n              \"width\": 518,\n              \"height\": 199\n          }\n      },\n      {\n          //TOYOTA精品\n          \"type\": \"uri\",\n          \"linkUri\": \"https://www.toyota.com.tw/collection.aspx\",\n          \"area\": {\n              \"x\": 0,\n              \"y\": 383,\n              \"width\": 519,\n              \"height\": 199\n          }\n      },\n      {\n          //FB粉專\n          \"type\": \"uri\",\n          \"linkUri\": \"https://www.facebook.com/TOYOTA.Taiwan\",\n          \"area\": {\n              \"x\": 521,\n              \"y\": 383,\n              \"width\": 519,\n              \"height\": 200\n          }\n      },\n      {\n          //汽車保險\n          \"type\": \"uri\",\n          \"linkUri\": \"https://ec.hotains.com.tw/\",\n          \"area\": {\n              \"x\": 1,\n              \"y\": 585,\n              \"width\": 518,\n              \"height\": 199\n          }\n      },\n      {\n          //IG官方\n          \"type\": \"uri\",\n          \"linkUri\": \"https://www.instagram.com/toyotatw/\",\n          \"area\": {\n              \"x\": 522,\n              \"y\": 585,\n              \"width\": 518,\n              \"height\": 199\n          }\n      },\n      {\n          //汽車貸款\n          \"type\": \"uri\",\n          \"linkUri\": \"https://www.easypay.com.tw/02Inst1\",\n          \"area\": {\n              \"x\": 0,\n              \"y\": 786,\n              \"width\": 520,\n              \"height\": 254\n          }\n      },\n      {\n          //Youtube頻道\n          \"type\": \"uri\",\n          \"linkUri\": \"https://www.youtube.com/user/TOYOTA2012TW\",\n          \"area\": {\n              \"x\": 522,\n              \"y\": 787,\n              \"width\": 518,\n              \"height\": 253\n          }\n      }\n  ]\n};\n\nlet imageMapText = {\n    \"to\":target,\n    \"messages\":[\n        imageMap\n    ]\n};\n\nmsg.retMsg = imageMapText;\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 748.566650390625,
		"y": 1335,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "b672a78c.cb5848",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "FlowConfig",
		"func": "msg.req_para = msg.payload;\n\nnode.status({fill:\"green\",shape:\"dot\",text:new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]});\n\nmsg.flow_config = {\n    \"HT_API_host\":\"https://nodered-api-lexus-test.mybluemix.net/ht_api/\",\n    //\"HT_API_host\":\"https://htsr.hotaimotor.com.tw/LINEAPI_TEST/Service.asmx\",\n    \"HT_image_space\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/\",\n    //\"HT_image_space\": \"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage01/LINE_images_prod/\",\n    \"one_on_one_host\":\"http://192.168.43.43:8080/\",\n    \"watson_config\": [{\n        \"name\":\"Develop Assistant\",\n        \"workspaceId\": '234bf172-8356-42cc-8ec3-cb0a3dc69a0c',\n        \"username\": \"4003aefc-79f8-4c14-a497-f720829da4f0\",\n        \"password\": \"ZYqZvVngtxaX\"\n    }],\n    \"time_record\":{\n        request_time: Date.now()\n    }\n};\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 568.566650390625,
		"y": 375,
		"wires": [["2891cb43.bcbe94"]]
	}, {
		"id": "760fdb37.0091e4",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "Record",
		"func": "\nif(msg.payload!=null &&\n    msg.payload.context!=null &&\n    msg.payload.context.car_model_info\n){  //輸出context\n    msg.payload.context.car_model_info=\"Been reduced.\";\n}\n\nlet watson_says = msg.assistant_says!=null && \n                    msg.assistant_says.output!=null && \n                    msg.assistant_says.output.text!=null\n                    ?msg.assistant_says.output.text.join(\"\"):\"\";\n\nlet timestamp = Date.now();\n\nlet watson_assistant_out = null;\nif(msg.assistant_says!=null && !msg.passWatson){\n    watson_assistant_out = msg.assistant_says;\n    watson_assistant_out.workspaceId = msg.flow_config.usedWorkspace;\n    watson_assistant_out.watsonName = msg.flow_config.usedWatsonName;\n}\n\nreturn {\n    payload:Object.assign(\n        msg.flow_config.time_record,\n        {\n            watson_assistant_out:watson_assistant_out\n        },\n        {\n            input: msg.req_para.message,\n            output: msg.payload,\n            outputStr: watson_says,\n            timestamp:timestamp,\n            time : new Date(timestamp+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0],\n        }\n    )\n};",
		"outputs": 1,
		"noerr": 0,
		"x": 1484.449951171875,
		"y": 354.0333251953125,
		"wires": [["c2e992c9.184ca"]]
	}, {
		"id": "e8c7dcee.96e6c",
		"type": "catch",
		"z": "92820d3d.487bc8",
		"name": "",
		"scope": ["ed624382.d8f38", "ff66555c.8c77a8", "5f00487f.cbe7f8"],
		"x": 558.566650390625,
		"y": 975,
		"wires": [["9277f51.12b3f88"]]
	}, {
		"id": "9277f51.12b3f88",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "ERROR_RESPONSE",
		"func": "\nif(msg.req_para.context==null || typeof msg.req_para.context !=\"object\"){\n    msg.req_para.context = {};\n}\nmsg.req_para.context.doActions = [{\"text\":\"如有購車需求，歡迎前往全台展示中心，維修保養請洽服務廠，或點選線上文字客服，由專人為您服務唷，感謝您的詢問😊\",\"type\":\"buttons\",\"actions\":[{\"uri\":\"http://www.toyota.com.tw/location.aspx\",\"type\":\"uri\",\"label\":\"全台展示中心\"},{\"uri\":\"https://www.toyota.com.tw/dealer.aspx\",\"type\":\"uri\",\"label\":\"TOYOTA服務廠\"},{\"uri\":\"https://csonline.hotaimotor.com.tw/index.php\",\"type\":\"uri\",\"label\":\"線上文字客服\"}],\"altText\":\"如有購車需求，歡迎前往全台展示中心，維修保養請洽服務廠，或點選線上文字客服，由專人為您服務唷，感謝您的詢問😊\"}];\n\nmsg.payload = {\n\t\"intents\": [],\n\t\"entities\": [],\n\t\"input\": {\n\t\t\"text\": msg.req_para.message\n\t},\n\t\"output\": {\n\t\t\"text\": [\"\"],//Assistant發生異常Error\n\t},\n\t\"context\": msg.req_para.context\n};\n\nlet timestamp = Date.now();\nnode.status({fill:\"red\",shape:\"dot\",text:new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]+JSON.stringify(msg.error)});\nreturn[msg,{\n    payload:{\n        type: \"watson_throw\",\n        error: msg.error,\n        req_para: msg.req_para,\n        timestamp: timestamp,\n        time: new Date(new Date(timestamp).getTime()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0],\n        msgID:msg.msgID\n    }\n},{\n    payload:{\n        error_type:\"watson_throw\",\n        error:msg.error\n    }\n}];\n",
		"outputs": 3,
		"noerr": 0,
		"x": 728.566650390625,
		"y": 975,
		"wires": [["2e2e35e.527334a"], ["9e578843.045aa8"], ["960e42ce.fb19e8", "615342af.4734ac"]]
	}, {
		"id": "98169f83.c71a8",
		"type": "comment",
		"z": "92820d3d.487bc8",
		"name": "Deploy remind",
		"info": "ERROR有六個點不包含\n五個error下的子節點\nASSISTANT service",
		"x": 368.566650390625,
		"y": 75,
		"wires": []
	}, {
		"id": "d913ce2c.20f2c8",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "lottery_pic(正測不一)",
		"func": "let target =  msg.target;\nlet HT_image_space = msg.flow_config.HT_image_space;\nlet imageMap = {\n  \"type\": \"imagemap\",\n \n  \"baseUrl\": HT_image_space+\"promote_activity\",\n  \"altText\": \"TOYOTA LINE歡慶開台刮刮樂，抽沖繩愛的大冒險 ✨\",\n  \"baseSize\": {\n      \"height\": 1040,\n      \"width\": 1040\n  },\n  \"actions\": [\n      {\n          \"type\": \"uri\",\n          \"linkUri\": \"https://toyotadev.gadclubs.com/zh_TW/hotaimotor_verify_event\",\n          \"area\": {\n              \"x\": 0,\n              \"y\": 0,\n              \"width\": 1040,\n              \"height\": 1040\n          }\n      }\n  ]\n};\n\nlet imageMapText = {\n    \"to\":target,\n    \"messages\":[\n        imageMap\n    ]\n};\n\nmsg.retMsg = imageMapText;\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 778.566650390625,
		"y": 1295,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "27640eb.d6bc6f2",
		"type": "comment",
		"z": "92820d3d.487bc8",
		"name": "Error handling",
		"info": "",
		"x": 188.566650390625,
		"y": 74,
		"wires": []
	}, {
		"id": "14dc42c0.f297cd",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "Audio",
		"func": "msg.retMsg={\n    \"to\": \"\",\n    \"messages\":[\n        {\n            \"type\":\"text\",\n            \"text\":\"抱歉我聽不太懂，可以用文字告訴我嗎?\"\n        }\n    ],\n    \"context\":msg.req_para.context\n};\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 1108.566650390625,
		"y": 355,
		"wires": [["b5026eb6.eea8e"]]
	}, {
		"id": "76dcf504.62534c",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "Picture",
		"func": "msg.retMsg={\n    \"to\": \"\",\n    \"messages\":[\n        {\n            \"type\":\"text\",\n            \"text\":\"抱歉我看不懂圖片，可以用文字告訴我嗎?\"\n        }\n    ],\n    \"context\":msg.req_para.context\n};\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 1108.566650390625,
		"y": 315,
		"wires": [["b5026eb6.eea8e"]]
	}, {
		"id": "2e402ea.eb304d2",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SaveCloudantLog",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "Log",
		"service": "registered",
		"x": 1428.566650390625,
		"y": 475,
		"wires": []
	}, {
		"id": "12349448.2b14ec",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "ContextFormatMail",
		"func": "if(msg.payload!=null && msg.payload.context!=null && typeof msg.payload.context!=\"object\"){\n    return msg;\n}\n",
		"outputs": 1,
		"noerr": 0,
		"x": 938.566650390625,
		"y": 275,
		"wires": [["b5175248.95a3c8"]]
	}, {
		"id": "b5175248.95a3c8",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SendMail",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "Log",
		"service": "registered",
		"x": 1128.566650390625,
		"y": 235,
		"wires": []
	}, {
		"id": "36001c1f.f3e78c",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "Set 1st Assistant cfg",
		"func": "let workspace = msg.flow_config.watson_config[0];\nmsg.payload = msg.req_para.message;\nmsg.params = {\n    workspace_id: workspace.workspaceId,\n    username: workspace.username,\n    password: workspace.password,\n    context: msg.req_para.context\n};\n\nmsg.flow_config.usedWorkspace = workspace.workspaceId;\nmsg.flow_config.usedWatsonName = workspace.name;\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 428.566650390625,
		"y": 815,
		"wires": [["ed624382.d8f38"]]
	}, {
		"id": "ed624382.d8f38",
		"type": "watson-conversation-v1",
		"z": "92820d3d.487bc8",
		"name": "",
		"workspaceid": "",
		"multiuser": true,
		"context": false,
		"empty-payload": false,
		"default-endpoint": true,
		"service-endpoint": "https://gateway.watsonplatform.net/conversation/api",
		"timeout": "",
		"optout-learning": false,
		"x": 638.566650390625,
		"y": 815,
		"wires": [["c69c6f61.1a7bf", "6437607d.b67d58"]]
	}, {
		"id": "c69c6f61.1a7bf",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "if(\n    msg.payload && \n    msg.payload.output && \n    msg.payload.output.text && \n    msg.payload.output.text[0] && \n    msg.payload.output.text[0]==\"我無法回答此問題\" \n){\n    return [null,msg];\n}else{\n    return [msg,null];\n}",
		"outputs": 2,
		"noerr": 0,
		"x": 788.566650390625,
		"y": 815,
		"wires": [["2e2e35e.527334a"], ["2e2e35e.527334a"]]
	}, {
		"id": "993141cd.9061a8",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "Set 2nd Assistant cfg",
		"func": "let workspace = msg.flow_config.watson_config[1];\nmsg.payload = msg.req_para.message;\nmsg.params = {\n    workspace_id: workspace.workspaceId,\n    username: workspace.username,\n    password: workspace.password,\n    context: msg.req_para.context\n};\n\nmsg.flow_config.usedWorkspace = workspace.workspaceId;\nmsg.flow_config.usedWatsonName = workspace.name;\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 418.566650390625,
		"y": 872,
		"wires": [["ff66555c.8c77a8"]]
	}, {
		"id": "ff66555c.8c77a8",
		"type": "watson-conversation-v1",
		"z": "92820d3d.487bc8",
		"name": "",
		"workspaceid": "",
		"multiuser": true,
		"context": false,
		"empty-payload": false,
		"default-endpoint": true,
		"service-endpoint": "https://gateway.watsonplatform.net/conversation/api",
		"timeout": "",
		"optout-learning": false,
		"x": 638.566650390625,
		"y": 872,
		"wires": [["7f521b9a.fdb77c"]]
	}, {
		"id": "7f521b9a.fdb77c",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "if(\n    msg.payload && \n    msg.payload.output && \n    msg.payload.output.text && \n    msg.payload.output.text[0] && \n    msg.payload.output.text[0]==\"我無法回答此問題\" \n){\n    return [null,msg];\n}else{\n    return [msg,null];\n}",
		"outputs": 2,
		"noerr": 0,
		"x": 788.566650390625,
		"y": 872,
		"wires": [["2e2e35e.527334a"], ["2e2e35e.527334a"]]
	}, {
		"id": "d0ca8756.0703a8",
		"type": "link in",
		"z": "92820d3d.487bc8",
		"name": "Line TextMessage IN - B",
		"links": ["de7bb964.87525"],
		"x": 353.566650390625,
		"y": 695,
		"wires": [["99d10caa.e4037"]]
	}, {
		"id": "2e2e35e.527334a",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "msg.flow_config.time_record.assistant_return = Date.now();\nmsg.assistant_says = msg.payload;\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 968.566650390625,
		"y": 855,
		"wires": [["de9a28be.2efb58", "7456d913.ac2d58", "be2a8208.cae518"]]
	}, {
		"id": "99d10caa.e4037",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "msg.req_para.message = msg.req_para.message!=null?msg.req_para.message.toUpperCase().replace(/[\\t\\n\\r]/g,\"\"):\" \";\nmsg.target = msg.req_para.replyId;\nif(Array.isArray(msg.req_para.context)){\n    msg.req_para.context = null;\n}\nmsg.flow_config.time_record.assistant_call = Date.now();\nnode.status({fill:\"green\",shape:\"dot\",text:msg.req_para.message});\nnode.warn(\"says: \"+msg.req_para.message);\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 488.566650390625,
		"y": 695,
		"wires": [["e416fa27.9446d"]]
	}, {
		"id": "e416fa27.9446d",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "HardCodeResponse",
		"func": "\nlet hard_response = hard_code_response_check(msg.req_para.message);\n\nif( hard_response!=null){\n    \n    if(msg.req_para.context==null || typeof msg.req_para.context !=\"object\"){\n        msg.req_para.context = {};\n    }\n    let output_text = \"\";\n    output_text = hard_response[0].type?hard_response[0].type+\" template\":output_text;\n    output_text = hard_response[0].altText?hard_response[0].altText:output_text;\n    output_text = hard_response[0].text?hard_response[0].text:output_text;\n    \n    msg.req_para.context.doActions = hard_response;\n    msg.flow_config.usedWorkspace = \"\";\n    msg.flow_config.usedWatsonName = \"\";\n    msg.payload = {\n    \t\"intents\": [],\n    \t\"entities\": [],\n    \t\"input\": {\n    \t\t\"text\": msg.talkToWatson\n    \t},\n    \t\"output\": {\n    \t\t\"text\": [output_text],\n    \t},\n    \t\"context\": msg.req_para.context\n    }\n    msg.passWatson=true;\n    return [msg,null];\n}else{\n    return [null,msg];\n}\n\nfunction hard_code_response_check(message){\n    const input_doActions_pair = {\n        //\"#YTFFTW\":[{\"type\":\"YTFF\",}],\n        //\"YTFF\":[{\"type\":\"YTFF\"}],\n        //\"＃ＹＴＦＦＴＷ\":[{\"type\":\"YTFF\"}],\n        //\"ＹＴＦＦ\":[{\"type\":\"YTFF\"}],\n        \"聯絡專屬專員\":[{\"type\":\"special_coordinator\"}],\n        \"行動展間\":[{\"text\":\"你喜歡什麼類型的車子呢？\",\"type\":\"image_carousel\",\"altText\":\"轎車、掀背車、油電車、休旅車、跑車\",\"columns\":[{\"action\":{\"text\":\"轎車\",\"type\":\"message\",\"label\":\"轎車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_sedan.png\"},{\"action\":{\"text\":\"掀背車\",\"type\":\"message\",\"label\":\"掀背車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_hatchback.png\"},{\"action\":{\"text\":\"油電車\",\"type\":\"message\",\"label\":\"油電車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_eco_friendly.png\"},{\"action\":{\"text\":\"休旅車\",\"type\":\"message\",\"label\":\"休旅車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_RV.png\"},{\"action\":{\"text\":\"跑車\",\"type\":\"message\",\"label\":\"跑車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_sports_car.png\"}]}],\n        //cache\n        \"Hello TOYOTA行動客服\":[{\"text\":\"🙋HiHi！找我嘛～有什麼我可以為您服務的呢\",\"type\":\"carousel\",\"altText\":\"車款資訊、服務資訊、品牌資訊\",\"columns\":[{\"text\":\"服務目錄\",\"actions\":[{\"text\":\"車款資訊\",\"type\":\"message\",\"label\":\"車款資訊\"},{\"text\":\"服務資訊\",\"type\":\"message\",\"label\":\"服務資訊\"},{\"text\":\"品牌資訊\",\"type\":\"message\",\"label\":\"品牌資訊\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage01/LINE_images_prod/TOYOTA_LOGO.png\"}]}],\n        \"轎車\":[{\"text\":\"你想知道哪一台轎車的資訊呢？\",\"type\":\"carousel\",\"altText\":\"Altis, Altis X, Camry, Camry HYBRID, VIOS\",\"columns\":[{\"text\":\"Altis\",\"actions\":[{\"text\":\"我想知道Altis的售價\",\"type\":\"message\",\"label\":\"Altis售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2017092114491443673042.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/ALTIS\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_altis.png\"},{\"text\":\"Altis X\",\"actions\":[{\"text\":\"我想知道ALTIS X的售價\",\"type\":\"message\",\"label\":\"ALTIS X售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2017092114491443673042.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/ALTIS\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_altis_x.png\"},{\"text\":\"Camry\",\"actions\":[{\"text\":\"我想知道CAMRY的售價\",\"type\":\"message\",\"label\":\"CAMRY售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2017100613253865091513.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/CAMRY\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_camry.png\"},{\"text\":\"Camry HYBRID\",\"actions\":[{\"text\":\"我想知道CAMRY Hybrid的售價\",\"type\":\"message\",\"label\":\"CAMRY Hybrid售價\"},{\"uri\":\"https://www.toyota.com.tw/download_pdf.ashx?preview=&carsty=CAMRY_HYBRID\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/CAMRY_HYBRID\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_camry_hybrid.png\"},{\"text\":\"VIOS\",\"actions\":[{\"text\":\"我想知道VIOS的售價\",\"type\":\"message\",\"label\":\"VIOS售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_20180311154339F468KFB1.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/VIOS\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_vios.png\"}]}],\n        \"休旅車\":[{\"text\":\"請問是要問哪一種休旅車呢？\",\"type\":\"image_carousel\",\"altText\":\"運動休旅車(SUV)、多功能休旅車(MPV)\",\"columns\":[{\"action\":{\"text\":\"運動休旅車\",\"type\":\"message\",\"label\":\"運動休旅車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_3_SUV.png\"},{\"action\":{\"text\":\"多功能休旅車\",\"type\":\"message\",\"label\":\"多功能休旅車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_3_MPV.png\"}]}],\n        \"掀背車\":[{\"text\":\"你想知道哪一台掀背車的資訊呢？\",\"type\":\"carousel\",\"altText\":\"AURIS, YARIS, PRIUS c, PRIUS\",\"columns\":[{\"text\":\"AURIS\",\"actions\":[{\"text\":\"我想知道AURIS的售價\",\"type\":\"message\",\"label\":\"AURIS售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2018090816364462513858.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/AURIS\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_auris_v2.png\"},{\"text\":\"YARIS\",\"actions\":[{\"text\":\"我想知道YARIS的售價\",\"type\":\"message\",\"label\":\"YARIS售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2018040122382275700644.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/YARIS\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_yaris.png\"},{\"text\":\"PRIUS c\",\"actions\":[{\"text\":\"我想知道PRIUS c的售價\",\"type\":\"message\",\"label\":\"PRIUS c售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_201710061335220A85AB6C.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/PRIUS_c\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_prius_c.png\"},{\"text\":\"PRIUS\",\"actions\":[{\"text\":\"我想知道PRIUS的售價\",\"type\":\"message\",\"label\":\"PRIUS售價\"},{\"uri\":\"https://www.toyota.com.tw/download_pdf.ashx?preview=&carsty=PRIUS\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/PRIUS\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_prius.png\"}]}],\n        \"運動休旅車\":[{\"text\":\"你想知道哪一台運動休旅車(SUV)的資訊呢？\",\"type\":\"carousel\",\"altText\":\"你想知道哪一台運動休旅車(SUV)的資訊呢？\",\"columns\":[{\"text\":\"RAV4\",\"actions\":[{\"text\":\"我想知道RAV4的售價\",\"type\":\"message\",\"label\":\"RAV4售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2017102719164858BC3D81.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/RAV4\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_rav4.png\"},{\"text\":\"C-HR\",\"actions\":[{\"text\":\"我想知道C-HR的售價\",\"type\":\"message\",\"label\":\"C-HR售價\"},{\"uri\":\"https://www.toyota.com.tw/download_pdf.ashx?preview=&carsty=C-HR\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/C-HR\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_c_hr.png\"},{\"text\":\"RAV4 HYBRID\",\"actions\":[{\"text\":\"我想知道RAV4 Hybrid的售價\",\"type\":\"message\",\"label\":\"RAV4 Hybrid售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2017102719182513943774.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/RAV4_HYBRID\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_rav4_hybrid.png\"},{\"text\":\"PRADO\",\"actions\":[{\"text\":\"我想知道PRADO的售價\",\"type\":\"message\",\"label\":\"PRADO售價\"},{\"text\":\"我想知道PRADO的規格\",\"type\":\"message\",\"label\":\"PRADO規格\"},{\"uri\":\"https://www.toyota.com.tw/download_pdf.ashx?preview=&carsty=PRADO\",\"type\":\"uri\",\"label\":\"線上型錄\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_prado.png\"}]}],\n        \"車款資訊\":[{\"text\":\"你喜歡什麼類型的車子呢？\",\"type\":\"image_carousel\",\"altText\":\"轎車、掀背車、油電車、休旅車、跑車\",\"columns\":[{\"action\":{\"text\":\"轎車\",\"type\":\"message\",\"label\":\"轎車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_sedan.png\"},{\"action\":{\"text\":\"掀背車\",\"type\":\"message\",\"label\":\"掀背車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_hatchback.png\"},{\"action\":{\"text\":\"油電車\",\"type\":\"message\",\"label\":\"油電車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_eco_friendly.png\"},{\"action\":{\"text\":\"休旅車\",\"type\":\"message\",\"label\":\"休旅車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_RV.png\"},{\"action\":{\"text\":\"跑車\",\"type\":\"message\",\"label\":\"跑車\"},\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_type/car_type_1_sports_car.png\"}]}],\n        \"多功能休旅車\":[{\"text\":\"你想知道哪一台多功能休旅車(MPV)的資訊呢？\",\"type\":\"carousel\",\"altText\":\"你想知道哪一台多功能休旅車(MPV)的資訊呢？\",\"columns\":[{\"text\":\"SIENTA\",\"actions\":[{\"text\":\"我想知道SIENTA的售價\",\"type\":\"message\",\"label\":\"SIENTA售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2018010220454111421313.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/SIENTA\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_sienta.png\"},{\"text\":\"PREVIA\",\"actions\":[{\"text\":\"我想知道PREVIA的售價\",\"type\":\"message\",\"label\":\"PREVIA售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_201801171457599D426B8C.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/PREVIA\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_previa.png\"},{\"text\":\"SIENNA\",\"actions\":[{\"text\":\"我想知道SIENNA的售價\",\"type\":\"message\",\"label\":\"SIENNA售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_201804131348065COBKPL2.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/SIENNA\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_sienna.png\"},{\"text\":\"ALPHARD\",\"actions\":[{\"text\":\"我想知道ALPHARD的售價\",\"type\":\"message\",\"label\":\"ALPHARD售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2018022313570200000000.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/ALPHARD\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_alphard.png\"},{\"text\":\"PRADO\",\"actions\":[{\"text\":\"我想知道PRADO的售價\",\"type\":\"message\",\"label\":\"PRADO售價\"},{\"text\":\"我想知道PRADO的規格\",\"type\":\"message\",\"label\":\"PRADO規格\"},{\"uri\":\"https://www.toyota.com.tw/download_pdf.ashx?preview=&carsty=PRADO\",\"type\":\"uri\",\"label\":\"線上型錄\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_prado.png\"}]}],\n        //cache\n        \"系統建置中，敬請期待\":[{\"type\":\"carousel\",\"altText\":\"車款資訊、服務資訊、品牌資訊\",\"columns\":[{\"text\":\"服務目錄\",\"actions\":[{\"text\":\"車款資訊\",\"type\":\"message\",\"label\":\"車款資訊\"},{\"text\":\"服務資訊\",\"type\":\"message\",\"label\":\"服務資訊\"},{\"text\":\"品牌資訊\",\"type\":\"message\",\"label\":\"品牌資訊\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage01/LINE_images_prod/TOYOTA_LOGO.png\"}]}],\n        \"跑車\":[{\"text\":\"想知道跑車 86 的什麼資訊呢？\",\"type\":\"carousel\",\"altText\":\"售價, 線上型錄, 預約試乘\",\"columns\":[{\"text\":\"86\",\"actions\":[{\"text\":\"我想知道86的售價\",\"type\":\"message\",\"label\":\"86售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_20171226193630O5P9DADH.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/86\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_86.png\"}]}],\n        \"插電式油電複合車\":[{\"text\":\"想知道插電式油電複合車PRIUS PHV的什麼資訊呢？\",\"type\":\"carousel\",\"altText\":\"想知道插電式油電複合車PRIUS PHV的什麼資訊呢？\",\"columns\":[{\"text\":\"PRIUS PHV\",\"actions\":[{\"text\":\"我想知道PRIUS PHV的售價\",\"type\":\"message\",\"label\":\"PRIUS PHV售價\"},{\"uri\":\"https://hotaicdn.azureedge.net/toyotaweb/CAR_2017063012175932071813.pdf\",\"type\":\"uri\",\"label\":\"線上型錄\"},{\"uri\":\"https://www.toyota.com.tw/testdrive.aspx#/PRIUS_PHV\",\"type\":\"uri\",\"label\":\"預約試乘\"}],\"imageUrl\":\"https://s3-api.us-geo.objectstorage.softlayer.net/tytimage/LINE_images_test/car_model/car_model_prius_phv.png\"}]}],\n        \"品牌資訊\":[{\"type\":\"some_menu\"}],\n        \"維修保養\":[{\"text\":\"您好，建議您洽詢TOYOTA服務廠或點選線上文字客服，由專人為您服務，謝謝\",\"type\":\"buttons\",\"actions\":[{\"uri\":\"https://www.toyota.com.tw/dealer.aspx\",\"type\":\"uri\",\"label\":\"TOYOTA服務廠\"},{\"uri\":\"https://csonline.hotaimotor.com.tw/index.php\",\"type\":\"uri\",\"label\":\"線上文字客服\"}],\"altText\":\"您好，建議您洽詢TOYOTA服務廠或點選線上文字客服，由專人為您服務，謝謝\"}]\n    }\n    return input_doActions_pair[message];\n}\n\nfunction UUID() {\n  var d = Date.now();\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function'){\n    d += performance.now(); //use high-precision timer if available\n  }\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    var r = (d + Math.random() * 16) % 16 | 0;\n    d = Math.floor(d / 16);\n      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);\n  });\n}\n\n",
		"outputs": 2,
		"noerr": 0,
		"x": 718.566650390625,
		"y": 695,
		"wires": [["2e2e35e.527334a"], ["36001c1f.f3e78c"]]
	}, {
		"id": "9ec72007.14fdc8",
		"type": "link out",
		"z": "92820d3d.487bc8",
		"name": "華生說-A for 5",
		"links": ["edf39080.fcc"],
		"x": 1213.566650390625,
		"y": 855,
		"wires": []
	}, {
		"id": "de9a28be.2efb58",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "var outputText = msg.payload.output.text.join(\"\").replace(/\\n/g,\"\");\n\nif(msg.payload.context.doActions!=null && msg.payload.context.doActions.length>0){\n   msg.watson_doActions = msg.payload.context.doActions ;\n}else if(exist_str_btn(outputText)){\n    msg.watson_doActions = combine_btn(outputText);\n}else{\n    msg.watson_doActions = [{\n        \"type\": \"text\",\n        \"text\": outputText\n    }];\n}\n\nreturn msg;\n\nfunction exist_str_btn(text){\n    \n    if(text && text.split(\"1.\").length>1){\n        if(!text.split(\"1.\")[1].startsWith(\"pdf\")){\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction combine_btn(text){\n    \n    let buttonTitle = \"\";\n    let buttonAssign=[];\n    buttonTitle = text.split(\"1.\")[0];\n    buttonTitle = buttonTitle==\"\"?\"　\":buttonTitle;\n\n    for(var i=1;i<10;i++){\n        if(text.split(i+\".\").length>1){\n            let fetchStr = text\n            \t\t    .split(i+\".\")[1]\n            \t\t    .split((i+1)+\".\")[0];\n            buttonAssign.push(fetchStr.trim());\n        }\n    }\n    \n    return [{\n        buttonTitle : buttonTitle,\n        buttonAssign : buttonAssign,\n        type : \"my_btns\"\n    }]\n}\n\n",
		"outputs": 1,
		"noerr": 0,
		"x": 1108.566650390625,
		"y": 855,
		"wires": [["9ec72007.14fdc8"]]
	}, {
		"id": "7456d913.ac2d58",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "\nif(msg.payload.output.error!=null){\n    let timestamp = Date.now();\n    msg.payload.type = \"watson_says\";\n    msg.payload.error = msg.payload.output.error;\n    msg.payload.timestamp=timestamp;\n    msg.payload.time = new Date(new Date(timestamp).getTime()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0];\n    node.status({fill:\"red\",shape:\"dot\",text:msg.payload.error});\n    return [msg,{\n        payload:{\n            error_type:\"watson_says\",\n            error:msg.payload.error\n        }\n    }];\n}",
		"outputs": 2,
		"noerr": 0,
		"x": 1108.566650390625,
		"y": 895,
		"wires": [["f800fea3.4766e8"], ["a40724ae.1c7f28"]]
	}, {
		"id": "f800fea3.4766e8",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SaveCloudantError",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "Error",
		"service": "registered",
		"x": 1248.566650390625,
		"y": 895,
		"wires": []
	}, {
		"id": "dc0daa6.1f40858",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SaveCloudantLog",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "Log",
		"service": "registered",
		"x": 1188.566650390625,
		"y": 495,
		"wires": []
	}, {
		"id": "c2e992c9.184ca",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SaveCloudantLog",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "Log",
		"service": "registered",
		"x": 1628.566650390625,
		"y": 355,
		"wires": []
	}, {
		"id": "6b6a8751.6a768",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "let timestamp = Date.now();\nmsg.flow_config.time_record.response_time = timestamp;\n\nreturn {\n    payload:Object.assign(\n        msg.flow_config.time_record,\n        {\n            input: msg.req_para.message,\n            output: msg.payload,\n            timestamp:timestamp,\n            time : new Date(timestamp+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0],\n        }\n    )\n};",
		"outputs": 1,
		"noerr": 0,
		"x": 1288.566650390625,
		"y": 455,
		"wires": [["2e402ea.eb304d2"]]
	}, {
		"id": "c151879.ccea678",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "let timestamp = Date.now();\nmsg.flow_config.time_record.response_time = timestamp;\n\nreturn {\n    payload:Object.assign(\n        msg.flow_config.time_record,\n        {\n            input: msg.req_para.message,\n            output: msg.payload,\n            timestamp:timestamp,\n            time : new Date(timestamp+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0],\n        }\n    )\n};",
		"outputs": 1,
		"noerr": 0,
		"x": 1048.566650390625,
		"y": 475,
		"wires": [["dc0daa6.1f40858"]]
	}, {
		"id": "5a0fc45.378e23c",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SaveCloudantError",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "Error",
		"service": "registered",
		"x": 648.566650390625,
		"y": 95,
		"wires": []
	}, {
		"id": "be2a8208.cae518",
		"type": "debug",
		"z": "92820d3d.487bc8",
		"name": "DoActions",
		"active": false,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "assistant_says.context.doActions",
		"x": 1118.566650390625,
		"y": 795,
		"wires": []
	}, {
		"id": "960e42ce.fb19e8",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SendErrorMail",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "SendErrorMail",
		"service": "registered",
		"x": 958.566650390625,
		"y": 1015,
		"wires": []
	}, {
		"id": "d1d35fd4.26c8d8",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SendErrorMail",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "SendErrorMail",
		"service": "registered",
		"x": 678.566650390625,
		"y": 175,
		"wires": []
	}, {
		"id": "a40724ae.1c7f28",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SendErrorMail",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "SendErrorMail",
		"service": "registered",
		"x": 1278.566650390625,
		"y": 935,
		"wires": []
	}, {
		"id": "9e578843.045aa8",
		"type": "ibmiot out",
		"z": "92820d3d.487bc8",
		"authentication": "boundService",
		"apiKey": "",
		"outputType": "evt",
		"deviceId": "TaipeiDigital",
		"deviceType": "robot",
		"eventCommandType": "SaveCloudantError",
		"format": "json",
		"data": "msg.payload",
		"qos": 0,
		"name": "Error",
		"service": "registered",
		"x": 928.566650390625,
		"y": 975,
		"wires": []
	}, {
		"id": "615342af.4734ac",
		"type": "debug",
		"z": "92820d3d.487bc8",
		"name": "DoActions",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 958.566650390625,
		"y": 1055,
		"wires": []
	}, {
		"id": "6437607d.b67d58",
		"type": "debug",
		"z": "92820d3d.487bc8",
		"name": "AssistantOut",
		"active": false,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 978.566650390625,
		"y": 695,
		"wires": []
	}, {
		"id": "ab31ca9d.44487",
		"type": "debug",
		"z": "92820d3d.487bc8",
		"name": "DEBUG",
		"active": false,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "true",
		"x": 1298.566650390625,
		"y": 214,
		"wires": []
	}, {
		"id": "8529b27a.9f9a18",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "\nmsg.url = msg.flow_config.HT_API_host+\"LINE006_Q00\";\nmsg.headers = {\n    \"Content-Type\":\"application/x-www-form-urlencoded\"\n}\n\nmsg.payload = {\n    \"jsonstr\":JSON.stringify({\n        \"ENCYID\": msg.req_para.replyId,\n        \"FRAN\": \"L\"\n    })\n};\n\nreturn msg;\n\n",
		"outputs": 1,
		"noerr": 0,
		"x": 448.566650390625,
		"y": 1535,
		"wires": [["8006123a.042f4"]]
	}, {
		"id": "2b9caecc.b7006a",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "/*msg.payload = {\n    \"rtnCode\": \"0\",\n    \"rtnMsg\": \"\",\n    \"CSINFO\": [\n        {\n            \"LICSNO\": \"RBD-0021\",\n            \"FRAN\": \"L\",\n            \"CARNM\": \"IS300h\",\n            \"CRCOMPID\": \"AA\",\n            \"CRSALR\": \"AA94453\",\n            \"CRSALRNM\": \"楊建中\",\n            \"SRCOMPID\": \"AA\",\n            \"WHSRVNO\": \"AA94453\",\n            \"WHSRVNM\": \"劉伯溫\",\n            \"NICKNAME\": \"柏廷\",\n            \"PICURL\": \"https://profile.line-scdn.net/0huWZ840ahKnhnQQYLIUFVL1sEJBUQbywwH3IyGhJFJ0FMeGp5Wi9hSkBEI00ad256CCIyGEQVJhpL\"\n        }\n    ]\n}*/\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 668.566650390625,
		"y": 1535,
		"wires": [["e45d043d.c858d"]]
	}, {
		"id": "e45d043d.c858d",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "let one_on_one_host = msg.flow_config.one_on_one_host;\nlet target =  msg.target;\n\nlet sales_id_b64 = new Buffer(msg.payload.CSINFO[0].CRSALR).toString('base64');\nlet sales_name = msg.payload.CSINFO[0].CRSALRNM;\nlet service_id_b64 = new Buffer(msg.payload.CSINFO[0].WHSRVNO).toString('base64');\nlet service_name = msg.payload.CSINFO[0].WHSRVNM;\nlet cust_id_b64 = new Buffer(msg.req_para.replyId).toString('base64');\n\nlet sales_url = one_on_one_host+\"cust.do?c=\"+cust_id_b64+\"&s=\"+sales_id_b64;\nlet services_url = one_on_one_host+\"cust.do?c=\"+cust_id_b64+\"&s=\"+service_id_b64;\n\nlet messageTemplate=\n{\n\t\"to\": target,\n\t\"messages\": [{\n    \t\"type\":\"text\",\n    \t\"text\":\"您好，可以選擇需要對談之 '銷售專員' 或 '服務專員'， Lexus將為您介紹您的專屬專員\"\n    },{\n    \t\"type\": \"template\",\n    \t\"altText\": \"歡迎選擇您需要的專員\",\n    \t\"template\": {\n    \t\t\"type\": \"carousel\",\n    \t\t\"imageAspectRatio\": \"rectangle\",\n    \t\t\"imageSize\": \"cover\",\n    \t\t\"columns\": [{\n    \t\t\t\t\"text\": \"歡迎點選您需要的業務類別，若他因公務繁忙，請稍等一下喔\\n上班時間：09:00-19:00\",\n    \t\t\t\t\"actions\": [{\n    \t\t\t\t\t\t\"uri\": sales_url,\n    \t\t\t\t\t\t\"type\": \"uri\",\n    \t\t\t\t\t\t\"label\": \"銷售專員-\"+sales_name\n    \t\t\t\t\t},{\n    \t\t\t\t\t\t\"uri\": services_url,\n    \t\t\t\t\t\t\"type\": \"uri\",\n    \t\t\t\t\t\t\"label\": \"服務專員-\"+service_name\n    \t\t\t\t\t}\n    \t\t\t\t],\n    \t\t\t\t\"thumbnailImageUrl\": \"https://cdn2.ettoday.net/images/736/d736983.jpg\"\n    \t\t\t}\n    \t\t]\n    \t}\n    }]\n};\n\nmsg.retMsg = messageTemplate;\n\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 848.566650390625,
		"y": 1535,
		"wires": [["8438b525.1e6c88"]]
	}, {
		"id": "8006123a.042f4",
		"type": "http request",
		"z": "92820d3d.487bc8",
		"name": "",
		"method": "POST",
		"ret": "obj",
		"url": "",
		"tls": "",
		"x": 608.566650390625,
		"y": 1535,
		"wires": [["2b9caecc.b7006a"]]
	}, {
		"id": "7d18a763.7437c8",
		"type": "http in",
		"z": "92820d3d.487bc8",
		"name": "",
		"url": "/servicebot_conversation_1",
		"method": "post",
		"upload": false,
		"swaggerDoc": "",
		"x": 338.566650390625,
		"y": 335,
		"wires": [["b672a78c.cb5848", "925a6aa6.de0728"]]
	}, {
		"id": "d976d502.688fd8",
		"type": "function",
		"z": "92820d3d.487bc8",
		"name": "",
		"func": "msg.payload = {\n\t\"to\": msg.payload.replyId,\n\t\"messages\": [{\n\t\t\t\"type\": \"text\",\n\t\t\t\"text\": \"系統QA開發中，請耐心等候系統完成。\"\n\t\t}\n\t],\n\t\"context\": null\n}\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 548.566650390625,
		"y": 455,
		"wires": [["ed892581.0104e"]]
	}, {
		"id": "ed892581.0104e",
		"type": "http response",
		"z": "92820d3d.487bc8",
		"name": "",
		"statusCode": "200",
		"headers": {},
		"x": 706.566650390625,
		"y": 455,
		"wires": []
	}, {
		"id": "94660744.511e2",
		"type": "ibmiot in",
		"z": "952c8d23.7f0d4",
		"authentication": "boundService",
		"apiKey": "",
		"inputType": "evt",
		"logicalInterface": "",
		"ruleId": "",
		"deviceId": "TaipeiDigital",
		"applicationId": "",
		"deviceType": "robot",
		"eventType": "SaveCloudantLog",
		"commandType": "",
		"format": "json",
		"name": "IBM IoT",
		"service": "registered",
		"allDevices": "",
		"allApplications": "",
		"allDeviceTypes": false,
		"allLogicalInterfaces": "",
		"allEvents": false,
		"allCommands": "",
		"allFormats": "",
		"qos": 0,
		"x": 432.566650390625,
		"y": 170.56666564941406,
		"wires": [["bdddaf0d.d5c368"]]
	}, {
		"id": "e6e9d772.0a36f",
		"type": "ibmiot in",
		"z": "952c8d23.7f0d4",
		"authentication": "boundService",
		"apiKey": "",
		"inputType": "evt",
		"logicalInterface": "",
		"ruleId": "",
		"deviceId": "TaipeiDigital",
		"applicationId": "",
		"deviceType": "robot",
		"eventType": "SaveCloudantError",
		"commandType": "",
		"format": "json",
		"name": "IBM IoT",
		"service": "registered",
		"allDevices": "",
		"allApplications": "",
		"allDeviceTypes": false,
		"allLogicalInterfaces": "",
		"allEvents": false,
		"allCommands": "",
		"allFormats": "",
		"qos": 0,
		"x": 432.566650390625,
		"y": 230.56666564941406,
		"wires": [["c41d8d5a.d70d3"]]
	}, {
		"id": "efeaba4e.0379f8",
		"type": "ibmiot in",
		"z": "952c8d23.7f0d4",
		"authentication": "boundService",
		"apiKey": "",
		"inputType": "evt",
		"logicalInterface": "",
		"ruleId": "",
		"deviceId": "TaipeiDigital",
		"applicationId": "",
		"deviceType": "robot",
		"eventType": "SendMail",
		"commandType": "",
		"format": "json",
		"name": "IBM IoT",
		"service": "registered",
		"allDevices": "",
		"allApplications": "",
		"allDeviceTypes": false,
		"allLogicalInterfaces": "",
		"allEvents": false,
		"allCommands": "",
		"allFormats": "",
		"qos": 0,
		"x": 432.566650390625,
		"y": 290.56666564941406,
		"wires": [["8347d911.b9c55", "2608d09d.de6838"]]
	}, {
		"id": "ccec8a65.6e972",
		"type": "cloudant out",
		"z": "952c8d23.7f0d4",
		"name": "",
		"cloudant": "61dca38d.78e234",
		"database": "lineapi_log",
		"service": "nodeRed-API-Lexus-test-cloudantNoSQLDB",
		"payonly": true,
		"operation": "insert",
		"x": 742.566650390625,
		"y": 170.56666564941406,
		"wires": []
	}, {
		"id": "53b08eb6.df621",
		"type": "cloudant out",
		"z": "952c8d23.7f0d4",
		"name": "",
		"cloudant": "61dca38d.78e234",
		"database": "lineapi_error",
		"service": "nodeRed-API-Lexus-test-cloudantNoSQLDB",
		"payonly": true,
		"operation": "insert",
		"x": 752.566650390625,
		"y": 230.56666564941406,
		"wires": []
	}, {
		"id": "bb370e4b.7642",
		"type": "e-mail",
		"z": "952c8d23.7f0d4",
		"server": "smtp.gmail.com",
		"port": "465",
		"secure": true,
		"name": "",
		"dname": "",
		"x": 822.566650390625,
		"y": 290.56666564941406,
		"wires": []
	}, {
		"id": "8347d911.b9c55",
		"type": "function",
		"z": "952c8d23.7f0d4",
		"name": "context格式檢查",
		"func": "\nif(msg.payload!=null && msg.payload.context!=null && typeof msg.payload.context!=\"object\"){\n    let type = \"非規範格式\";\n    type = typeof msg.payload.context==\"string\"?\"字串\":type;\n    type = typeof msg.payload.context==\"number\"?\"數字\":type;\n    msg.payload=\"<font style='font-family: \\\"Microsoft JhengHei\\\";'>\"+\n                \"<b style='font-size:1.2em;'>錯誤原因</b>：<br>　LINEBOT不接受context格式為 '\"+type+\"' 之請求。<br><br>\"+\n                \"<b style='font-size:1.2em;'>發生時間</b>：<br>　\"+new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]+\"。<br><br>\"+\n                \"<b style='font-size:1.2em;'>錯誤API請求如下</b>：<br>\"+JSON.stringify(msg.payload, null, 4).replace(/    /g,\"　　　\").replace(/\\n/g,\"<br>\")+\"</font>\";\n    \n    msg.topic=\"LINEBOT環境收到錯誤API請求\";\n    msg.cc=\"benchen@pershing.com.tw\";\n    msg.to=\"GRACECHIU@mail.hotaimotor.com.tw\";\n    return msg;\n}\n",
		"outputs": 1,
		"noerr": 0,
		"x": 632.566650390625,
		"y": 290.56666564941406,
		"wires": [[]]
	}, {
		"id": "eb7e8dc8.eb7af",
		"type": "function",
		"z": "952c8d23.7f0d4",
		"name": "Mail Test",
		"func": "//ptenzyqxqobotpsc\nmsg = {\n    payload:{\n        context:\"\",\n        type:\"text\",\n        message:\"妳好\"\n    }\n}\nif(msg.payload!=null && msg.payload.context!=null && typeof msg.payload.context!=\"object\"){\n    let type = \"非規範格式\";\n    type = typeof msg.payload.context==\"string\"?\"字串\":type;\n    type = typeof msg.payload.context==\"number\"?\"數字\":type;\n    msg.payload=\"<font style='font-family: \\\"Microsoft JhengHei\\\";'>\"+\n                \"<b style='font-size:1.2em;'>錯誤原因</b>：<br>　LINEBOT不接受context格式為 '\"+type+\"' 之請求。<br><br>\"+\n                \"<b style='font-size:1.2em;'>發生時間</b>：<br>　\"+new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]+\"。<br><br>\"+\n                \"<b style='font-size:1.2em;'>錯誤API請求如下</b>：<br>\"+JSON.stringify(msg.payload, null, 4).replace(/    /g,\"　　　\").replace(/\\n/g,\"<br>\")+\"</font>\";\n    \n    msg.topic=\"發信測試\";\n    msg.to=\"benchen@pershing.com.tw\";\n    msg.cc=\"g4ru04@gmail.com\";\n    return msg;\n}\n",
		"outputs": 1,
		"noerr": 0,
		"x": 612.566650390625,
		"y": 370.56666564941406,
		"wires": [["dd8bfe5c.8b3f98"]]
	}, {
		"id": "dd8bfe5c.8b3f98",
		"type": "e-mail",
		"z": "952c8d23.7f0d4",
		"server": "smtp.gmail.com",
		"port": "465",
		"secure": true,
		"name": "",
		"dname": "",
		"x": 832.566650390625,
		"y": 370.56666564941406,
		"wires": []
	}, {
		"id": "ce937896.1eb3f8",
		"type": "inject",
		"z": "952c8d23.7f0d4",
		"name": "",
		"topic": "",
		"payload": "",
		"payloadType": "date",
		"repeat": "",
		"crontab": "",
		"once": false,
		"onceDelay": 0.1,
		"x": 432.566650390625,
		"y": 370.56666564941406,
		"wires": [["eb7e8dc8.eb7af"]]
	}, {
		"id": "2608d09d.de6838",
		"type": "function",
		"z": "952c8d23.7f0d4",
		"name": "context格式檢查-Ben",
		"func": "\nif(msg.payload!=null && msg.payload.context!=null && typeof msg.payload.context!=\"object\"){\n    let type = \"非規範格式\";\n    type = typeof msg.payload.context==\"string\"?\"字串\":type;\n    type = typeof msg.payload.context==\"number\"?\"數字\":type;\n    msg.payload=\"<font style='font-family: \\\"Microsoft JhengHei\\\";'>\"+\n                \"<b style='font-size:1.2em;'>錯誤原因</b>：<br>　LINEBOT不接受context格式為 '\"+type+\"' 之請求。<br><br>\"+\n                \"<b style='font-size:1.2em;'>發生時間</b>：<br>　\"+new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]+\"。<br><br>\"+\n                \"<b style='font-size:1.2em;'>錯誤API請求如下</b>：<br>\"+JSON.stringify(msg.payload, null, 4).replace(/    /g,\"　　　\").replace(/\\n/g,\"<br>\")+\"</font>\";\n    \n    msg.topic=\"LINEBOT環境收到錯誤API請求\";\n    msg.to=\"benchen@pershing.com.tw\";\n    return msg;\n}\n",
		"outputs": 1,
		"noerr": 0,
		"x": 632.566650390625,
		"y": 330.56666564941406,
		"wires": [["bb370e4b.7642"]]
	}, {
		"id": "bdddaf0d.d5c368",
		"type": "function",
		"z": "952c8d23.7f0d4",
		"name": "",
		"func": "node.status({fill:\"green\",shape:\"dot\",text:new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]});\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 582.566650390625,
		"y": 170.56666564941406,
		"wires": [["ccec8a65.6e972"]]
	}, {
		"id": "c41d8d5a.d70d3",
		"type": "function",
		"z": "952c8d23.7f0d4",
		"name": "",
		"func": "node.status({fill:\"green\",shape:\"dot\",text:new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]});\nreturn msg;",
		"outputs": 1,
		"noerr": 0,
		"x": 582.566650390625,
		"y": 230.56666564941406,
		"wires": [["53b08eb6.df621"]]
	}, {
		"id": "8a15d1a8.048f88",
		"type": "ibmiot in",
		"z": "952c8d23.7f0d4",
		"authentication": "boundService",
		"apiKey": "",
		"inputType": "evt",
		"logicalInterface": "",
		"ruleId": "",
		"deviceId": "TaipeiDigital",
		"applicationId": "",
		"deviceType": "robot",
		"eventType": "SendErrorMail",
		"commandType": "",
		"format": "json",
		"name": "IBM IoT",
		"service": "registered",
		"allDevices": "",
		"allApplications": "",
		"allDeviceTypes": false,
		"allLogicalInterfaces": "",
		"allEvents": false,
		"allCommands": "",
		"allFormats": "",
		"qos": 0,
		"x": 432.566650390625,
		"y": 530.5666656494141,
		"wires": [["7ba63075.1d0578", "50b44468.5f2f1c"]]
	}, {
		"id": "308871f2.d87a76",
		"type": "e-mail",
		"z": "952c8d23.7f0d4",
		"server": "smtp.gmail.com",
		"port": "465",
		"secure": true,
		"name": "",
		"dname": "",
		"x": 762.566650390625,
		"y": 530.5666656494141,
		"wires": []
	}, {
		"id": "7ba63075.1d0578",
		"type": "function",
		"z": "952c8d23.7f0d4",
		"name": "錯誤發信",
		"func": "\nmsg.payload.error=msg.payload.error!=null?msg.payload.error:\"\";\nlet mail_msg = {\n    cc:\"g4ru04@gmail.com\",\n    topic: \"和泰LINE測試環境錯誤\",\n    to: \"benchen@pershing.com.tw\",\n    payload: (\n        \"<font style='font-family: \\\"Microsoft JhengHei\\\";'>\"+\n        \"<b style='font-size:1.2em;'>錯誤類型</b>：<br>　\"+\n        msg.payload.error_type + \"<br><br>\"+\n        \"<b style='font-size:1.2em;'>發生時間</b>：<br>　\"+\n        new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]+\"。<br><br>\"+\n        \"<b style='font-size:1.2em;'>錯誤如下</b>：<br>\"+\n        JSON.stringify(msg.payload.error, null, 4).replace(/    /g,\"　　　\").replace(/\\n/g,\"<br>\")+\n        \"</font>\"\n    )\n}\n\nnode.status({fill:\"red\",shape:\"dot\",text:new Date(Date.now()+8*3600*1000).toISOString().replace(\"T\",\" \").split(\".\")[0]});\nreturn mail_msg ;",
		"outputs": 1,
		"noerr": 0,
		"x": 592.566650390625,
		"y": 530.5666656494141,
		"wires": [["308871f2.d87a76"]]
	}, {
		"id": "50b44468.5f2f1c",
		"type": "debug",
		"z": "952c8d23.7f0d4",
		"name": "",
		"active": true,
		"tosidebar": true,
		"console": false,
		"tostatus": false,
		"complete": "false",
		"x": 592.566650390625,
		"y": 590.5666656494141,
		"wires": []
	}
]
